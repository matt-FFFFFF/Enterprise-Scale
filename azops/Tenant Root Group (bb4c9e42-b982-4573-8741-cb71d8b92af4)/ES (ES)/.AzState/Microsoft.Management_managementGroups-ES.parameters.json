{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "input": {
      "value": {
        "Id": "/providers/Microsoft.Management/managementGroups/ES",
        "Type": "/providers/Microsoft.Management/managementGroups",
        "Name": "ES",
        "TenantId": "bb4c9e42-b982-4573-8741-cb71d8b92af4",
        "DisplayName": "ES",
        "UpdatedTime": "0001-01-01T00:00:00Z",
        "UpdatedBy": null,
        "ParentId": "/providers/Microsoft.Management/managementGroups/bb4c9e42-b982-4573-8741-cb71d8b92af4",
        "ParentName": "bb4c9e42-b982-4573-8741-cb71d8b92af4",
        "ParentDisplayName": "Tenant Root Group",
        "Children": [
          {
            "Type": "/providers/Microsoft.Management/managementGroups",
            "Id": "/providers/Microsoft.Management/managementGroups/ES-platform",
            "Name": "ES-platform",
            "DisplayName": "Platform",
            "Children": [
              {
                "Type": "/providers/Microsoft.Management/managementGroups",
                "Id": "/providers/Microsoft.Management/managementGroups/ES-identity",
                "Name": "ES-identity",
                "DisplayName": "Identity",
                "Children": null
              },
              {
                "Type": "/providers/Microsoft.Management/managementGroups",
                "Id": "/providers/Microsoft.Management/managementGroups/ES-connectivity",
                "Name": "ES-connectivity",
                "DisplayName": "Connectivity",
                "Children": null
              },
              {
                "Type": "/providers/Microsoft.Management/managementGroups",
                "Id": "/providers/Microsoft.Management/managementGroups/ES-management",
                "Name": "ES-management",
                "DisplayName": "Management",
                "Children": [
                  {
                    "Type": "/subscriptions",
                    "Id": "/subscriptions/be3ae466-f78a-4e60-b972-d9c35a4e7b3b",
                    "Name": "be3ae466-f78a-4e60-b972-d9c35a4e7b3b",
                    "DisplayName": "LogicoreMSDNSub",
                    "Children": null
                  }
                ]
              }
            ]
          },
          {
            "Type": "/providers/Microsoft.Management/managementGroups",
            "Id": "/providers/Microsoft.Management/managementGroups/ES-landingzones",
            "Name": "ES-landingzones",
            "DisplayName": "LandingZones",
            "Children": null
          },
          {
            "Type": "/providers/Microsoft.Management/managementGroups",
            "Id": "/providers/Microsoft.Management/managementGroups/ES-sandbox",
            "Name": "ES-sandbox",
            "DisplayName": "Sandbox",
            "Children": null
          }
        ],
        "properties": {
          "policyDefinitions": [
            {
              "Name": "Append-KV-SoftDelete",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Append-KV-SoftDelete",
              "ResourceName": "Append-KV-SoftDelete",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Append-KV-SoftDelete",
              "Properties": {
                "Description": "When a Key Vault is created with out soft delete enabled then this will add it.",
                "DisplayName": "Append-KV-SoftDelete",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "equals": "Microsoft.KeyVault/vaults",
                            "field": "type"
                          },
                          {
                            "field": "Microsoft.KeyVault/vaults/enableSoftDelete",
                            "notEquals": false
                          }
                        ]
                      }
                    ]
                  },
                  "then": {
                    "details": [
                      {
                        "field": "Microsoft.KeyVault/vaults/enableSoftDelete",
                        "value": true
                      }
                    ],
                    "effect": "append"
                  }
                }
              }
            },
            {
              "Name": "Deny-AppGW-Without-WAF",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-AppGW-Without-WAF",
              "ResourceName": "Deny-AppGW-Without-WAF",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-AppGW-Without-WAF",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deny-AppGW-Without-WAF",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/applicationGateways",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.Network/applicationGateways/sku.name",
                        "notequals": "WAF_v2"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-ERPeering",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-ERPeering",
              "ResourceName": "Deny-ERPeering",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-ERPeering",
              "Properties": {
                "Description": "Denies creation of ER Peerings under the assigned scope.",
                "DisplayName": "Deny-ERPeering",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                    "field": "type"
                  },
                  "then": {
                    "effect": "deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-Private-DNS-Zones",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-Private-DNS-Zones",
              "ResourceName": "Deny-Private-DNS-Zones",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-Private-DNS-Zones",
              "Properties": {
                "Description": "Denies creation of Private DNS Zones at the assigned scope.",
                "DisplayName": "Deny-Private-DNS-Zones",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/privateDnsZones",
                    "field": "type"
                  },
                  "then": {
                    "effect": "deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-Aks",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Aks",
              "ResourceName": "Deny-PublicEndpoint-Aks",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Aks",
              "Properties": {
                "Description": "This policy restricts creation of non-private AKS clusters",
                "DisplayName": "Deny-PublicEndpoint-Aks",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.ContainerService/managedClusters",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.ContainerService/managedClusters/apiServerAccessProfile.enablePrivateCluster",
                        "notequals": "true"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-CosmosDB",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-CosmosDB",
              "ResourceName": "Deny-PublicEndpoint-CosmosDB",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-CosmosDB",
              "Properties": {
                "Description": "This policy restrict creation of cosmos db accounts with exposed public endpoints",
                "DisplayName": "Deny-PublicEndpoint-CosmosDB",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.DocumentDB/databaseAccounts",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.DocumentDB/databaseAccounts/publicNetworkAccess",
                        "notequals": "Disabled"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-KeyVault",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-KeyVault",
              "ResourceName": "Deny-PublicEndpoint-KeyVault",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-KeyVault",
              "Properties": {
                "Description": "This policy restrict creation of Key Vaults with IP Firewall exposed to all public endpoints",
                "DisplayName": "Deny-PublicEndpoint-KeyVault",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.KeyVault/vaults",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.KeyVault/vaults/networkAcls.defaultAction",
                        "notequals": "Deny"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-MariaDB",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-MariaDB",
              "ResourceName": "Deny-PublicEndpoint-MariaDB",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-MariaDB",
              "Properties": {
                "Description": "This policy restrict creation of Maria DB accounts with exposed public endpoints",
                "DisplayName": "Deny-PublicEndpoint-MariaDB",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.DBforMariaDB/servers",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.DBforMariaDB/servers/publicNetworkAccess",
                        "notequals": "Disabled"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-MySQL",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-MySQL",
              "ResourceName": "Deny-PublicEndpoint-MySQL",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-MySQL",
              "Properties": {
                "Description": "This policy restrict creation of MySql DB accounts with exposed public endpoints",
                "DisplayName": "Deny-PublicEndpoint-MySQL",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.DBforMySQL/servers",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.DBforMySQL/servers/publicNetworkAccess",
                        "notequals": "Disabled"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-PostgreSql",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-PostgreSql",
              "ResourceName": "Deny-PublicEndpoint-PostgreSql",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-PostgreSql",
              "Properties": {
                "Description": "This policy restrict creation of Postgre SQL DB accounts with exposed public endpoints",
                "DisplayName": "Deny-PublicEndpoint-PostgreSql",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.DBforPostgreSQL/servers",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.DBforPostgreSQL/servers/publicNetworkAccess",
                        "notequals": "Disabled"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-Sql",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Sql",
              "ResourceName": "Deny-PublicEndpoint-Sql",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Sql",
              "Properties": {
                "Description": "This policy restrict creation of Sql servers with exposed public endpoints",
                "DisplayName": "Deny-PublicEndpoint-Sql",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Sql/servers",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.Sql/servers/publicNetworkAccess",
                        "notequals": "Disabled"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicEndpoint-Storage",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Storage",
              "ResourceName": "Deny-PublicEndpoint-Storage",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Storage",
              "Properties": {
                "Description": "This policy restrict creation of storage accounts with IP Firewall exposed to all public endpoints",
                "DisplayName": "Deny-PublicEndpoint-Storage",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Storage/storageAccounts",
                        "field": "type"
                      },
                      {
                        "field": "Microsoft.Storage/storageAccounts/networkAcls.defaultAction",
                        "notequals": "Deny"
                      }
                    ]
                  },
                  "then": {
                    "effect": "Deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-PublicIP",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicIP",
              "ResourceName": "Deny-PublicIP",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicIP",
              "Properties": {
                "Description": "Denies creation of Public IPs under the assigned scope.",
                "DisplayName": "Deny-PublicIP",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/publicIPAddresses",
                    "field": "type"
                  },
                  "then": {
                    "effect": "deny"
                  }
                }
              }
            },
            {
              "Name": "Deny-Subnet-Without-Nsg",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-Subnet-Without-Nsg",
              "ResourceName": "Deny-Subnet-Without-Nsg",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-Subnet-Without-Nsg",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deny-Subnets-Without-NSG",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/virtualNetworks/subnets",
                        "field": "type"
                      },
                      {
                        "exists": "false",
                        "field": "Microsoft.Network/virtualNetworks/subnets/networkSecurityGroup.id"
                      }
                    ]
                  },
                  "then": {
                    "effect": "deny"
                  }
                }
              }
            },
            {
              "Name": "Deploy-ASC-CE",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-ASC-CE",
              "ResourceName": "Deploy-ASC-CE",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-ASC-CE",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-ASC-ContinuousExportToWorkspace",
                "Mode": "All",
                "Parameters": {
                  "alertSeverities": {
                    "type": "Array",
                    "metadata": {
                      "description": "To select specific alert severities, please untick the appropriate ones",
                      "displayName": "Alert severities (applicable only for export of security alerts)"
                    },
                    "allowedValues": [
                      "High",
                      "Medium",
                      "Low"
                    ],
                    "defaultValue": [
                      "High",
                      "Medium",
                      "Low"
                    ]
                  },
                  "exportedDataTypes": {
                    "type": "Array",
                    "metadata": {
                      "description": "Choose the data type/s to be exported",
                      "displayName": "Exported data types"
                    },
                    "allowedValues": [
                      "Security recommendations",
                      "Security alerts"
                    ],
                    "defaultValue": [
                      "Security recommendations",
                      "Security alerts"
                    ]
                  },
                  "recommendationNames": {
                    "type": "Array",
                    "metadata": {
                      "description": "For all recommendations please leave empty. For specific recommendations please insert a list of recommendation IDs separated by ';'. Recommendation IDs are available through Assessments API (https://docs.microsoft.com/en-us/rest/api/securitycenter/assessments), or Azure Resource Graph Explorer (https://ms.portal.azure.com/#blade/HubsExtension/ArgQueryBlade), choose securityresources and microsoft.security/assessments",
                      "displayName": "Recommendation IDs (applicable only for export of security recommendations)"
                    },
                    "defaultValue": []
                  },
                  "recommendationSeverities": {
                    "type": "Array",
                    "metadata": {
                      "description": "To select specific recommendation severities, please untick the appropriate ones",
                      "displayName": "Recommendation severities (applicable only for export of security recommendations)"
                    },
                    "allowedValues": [
                      "High",
                      "Medium",
                      "Low"
                    ],
                    "defaultValue": [
                      "High",
                      "Medium",
                      "Low"
                    ]
                  },
                  "resourceGroupLocation": {
                    "type": "String",
                    "metadata": {
                      "description": "If you inserted an existing resource group, please select its location. In case this is a new resource group, please choose a location for it",
                      "displayName": "Resource group location",
                      "strongType": "location"
                    }
                  },
                  "workspaceResourceId": {
                    "type": "String",
                    "metadata": {
                      "description": "Insert the resource ID of the Log Analytics Workspace for export",
                      "displayName": "Log Analytics Workspace resource ID",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Resources/subscriptions",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "ResourceGroupName": "[concat(subscription().displayName, '-asc')]",
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "alertSeverities": {
                              "value": "[parameters('alertSeverities')]"
                            },
                            "exportedDataTypes": {
                              "value": "[parameters('exportedDataTypes')]"
                            },
                            "recommendationNames": {
                              "value": "[parameters('recommendationNames')]"
                            },
                            "recommendationSeverities": {
                              "value": "[parameters('recommendationSeverities')]"
                            },
                            "resourceGroupLocation": {
                              "value": "[parameters('resourceGroupLocation')]"
                            },
                            "subscriptionAzureResourceId": {
                              "value": "[subscription().id]"
                            },
                            "subscriptionId": {
                              "value": "[subscription().subscriptionId]"
                            },
                            "workspaceResourceId": {
                              "value": "[parameters('workspaceResourceId')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "alertSeverities": {
                                "type": "array"
                              },
                              "exportedDataTypes": {
                                "type": "array"
                              },
                              "recommendationNames": {
                                "type": "array"
                              },
                              "recommendationSeverities": {
                                "type": "array"
                              },
                              "resourceGroupLocation": {
                                "type": "string"
                              },
                              "subscriptionAzureResourceId": {
                                "type": "string"
                              },
                              "subscriptionId": {
                                "type": "string"
                              },
                              "workspaceResourceId": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2019-10-01",
                                "location": "[parameters('resourceGroupLocation')]",
                                "name": "[variables('resourceGroupName')]",
                                "properties": {},
                                "tags": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2019-10-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', variables('resourceGroupName'))]"
                                ],
                                "name": "nestedAutomationDeployment",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2019-01-01-preview",
                                        "dependsOn": [],
                                        "location": "[parameters('resourceGroupLocation')]",
                                        "name": "ExportToWorkspace",
                                        "properties": {
                                          "actions": [
                                            {
                                              "actionType": "Workspace",
                                              "workspaceResourceId": "[parameters('workspaceResourceId')]"
                                            }
                                          ],
                                          "copy": [
                                            {
                                              "count": "[variables('exportedDataTypesLengthIfEmpty')]",
                                              "input": {
                                                "eventSource": "[variables('dataTypeMap')[parameters('exportedDataTypes')[copyIndex('sources')]]]",
                                                "ruleSets": "[if(equals(parameters('exportedDataTypes')[copyIndex('sources')], 'Security recommendations'), variables('ruleSetsForAssessmentsObj').ruleSetsForAssessmentsArr, variables('ruleSetsForAlertsObj').ruleSetsForAlertsArr)]"
                                              },
                                              "name": "sources"
                                            }
                                          ],
                                          "description": "Export Azure Security Center Alerts and/or Recommendations to Log Analytics Workspace via Policy",
                                          "isEnabled": true,
                                          "scopes": [
                                            {
                                              "description": "[replace(variables('scopeDescription'),'{0}', parameters('subscriptionId'))]",
                                              "scopePath": "[parameters('subscriptionAzureResourceId')]"
                                            }
                                          ]
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Security/automations"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[variables('resourceGroupName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ],
                            "variables": {
                              "alertSeveritiesLength": "[length(parameters('alertSeverities'))]",
                              "alertSeveritiesLengthIfEmpty": "[if(equals(variables('alertSeveritiesLength'), 0), 1, variables('alertSeveritiesLength'))]",
                              "alertSeverityMap": {
                                "High": "high",
                                "Low": "low",
                                "Medium": "medium"
                              },
                              "dataTypeMap": {
                                "Security alerts": "Alerts",
                                "Security recommendations": "Assessments"
                              },
                              "exportedDataTypesLength": "[length(parameters('exportedDataTypes'))]",
                              "exportedDataTypesLengthIfEmpty": "[if(equals(variables('exportedDataTypesLength'), 0), 1, variables('exportedDataTypesLength'))]",
                              "recommendationNamesLength": "[length(parameters('recommendationNames'))]",
                              "recommendationNamesLengthIfEmpty": "[if(equals(variables('recommendationNamesLength'), 0), 1, variables('recommendationNamesLength'))]",
                              "recommendationSeveritiesLength": "[length(parameters('recommendationSeverities'))]",
                              "recommendationSeveritiesLengthIfEmpty": "[if(equals(variables('recommendationSeveritiesLength'), 0), 1, variables('recommendationSeveritiesLength'))]",
                              "resourceGroupName": "[concat(subscription().displayName, '-asc')]",
                              "ruleSetsForAlertsObj": {
                                "copy": [
                                  {
                                    "count": "[variables('alertSeveritiesLengthIfEmpty')]",
                                    "input": {
                                      "rules": [
                                        {
                                          "expectedValue": "[variables('alertSeverityMap')[parameters('alertSeverities')[mod(copyIndex('ruleSetsForAlertsArr'),variables('alertSeveritiesLengthIfEmpty'))]]]",
                                          "operator": "Equals",
                                          "propertyJPath": "Severity",
                                          "propertyType": "string"
                                        }
                                      ]
                                    },
                                    "name": "ruleSetsForAlertsArr"
                                  }
                                ]
                              },
                              "ruleSetsForAssessmentsObj": {
                                "copy": [
                                  {
                                    "count": "[mul(variables('recommendationNamesLengthIfEmpty'),variables('recommendationSeveritiesLengthIfEmpty'))]",
                                    "input": {
                                      "rules": [
                                        {
                                          "expectedValue": "[if(equals(variables('recommendationNamesLength'),0),'Microsoft.Security/assessments',parameters('recommendationNames')[mod(div(copyIndex('ruleSetsForAssessmentsArr'),variables('totalRuleCombinationsForOneRecommendationName')),variables('recommendationNamesLength'))])]",
                                          "operator": "Contains",
                                          "propertyJPath": "[if(equals(variables('recommendationNamesLength'),0),'type','name')]",
                                          "propertyType": "string"
                                        },
                                        {
                                          "expectedValue": "[parameters('recommendationSeverities')[mod(div(copyIndex('ruleSetsForAssessmentsArr'),variables('totalRuleCombinationsForOneRecommendationSeverity')),variables('recommendationSeveritiesLength'))]]",
                                          "operator": "Equals",
                                          "propertyJPath": "properties.metadata.severity",
                                          "propertyType": "string"
                                        }
                                      ]
                                    },
                                    "name": "ruleSetsForAssessmentsArr"
                                  }
                                ]
                              },
                              "scopeDescription": "scope for subscription {0}",
                              "totalRuleCombinationsForOneRecommendationName": "[variables('recommendationSeveritiesLengthIfEmpty')]",
                              "totalRuleCombinationsForOneRecommendationSeverity": 1
                            }
                          }
                        }
                      },
                      "deploymentScope": "subscription",
                      "existenceScope": "resourcegroup",
                      "name": "ExportToWorkspace",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Security/automations"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-ASC-Standard",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-ASC-Standard",
              "ResourceName": "Deploy-ASC-Standard",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-ASC-Standard",
              "Properties": {
                "Description": "Ensures that subscriptions have Security Center Standard enabled.",
                "DisplayName": "Deploy-ASC-Standard",
                "Mode": "All",
                "Parameters": {
                  "pricingTierAppServices": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierAppServices"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  },
                  "pricingTierContainerRegistry": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierContainerRegistry"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  },
                  "pricingTierKeyVaults": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierKeyVaults"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  },
                  "pricingTierKubernetesService": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierKubernetesService"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  },
                  "pricingTierSqlServers": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierSqlServers"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  },
                  "pricingTierStorageAccounts": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierStorageAccounts"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  },
                  "pricingTierVMs": {
                    "type": "String",
                    "metadata": {
                      "displayName": "pricingTierVMs"
                    },
                    "allowedValues": [
                      "Standard",
                      "Free"
                    ],
                    "defaultValue": "Standard"
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "pricingTierAppServices": {
                              "value": "[parameters('pricingTierAppServices')]"
                            },
                            "pricingTierContainerRegistry": {
                              "value": "[parameters('pricingTierContainerRegistry')]"
                            },
                            "pricingTierKeyVaults": {
                              "value": "[parameters('pricingTierKeyVaults')]"
                            },
                            "pricingTierKubernetesService": {
                              "value": "[parameters('pricingTierKubernetesService')]"
                            },
                            "pricingTierSqlServers": {
                              "value": "[parameters('pricingTierSqlServers')]"
                            },
                            "pricingTierStorageAccounts": {
                              "value": "[parameters('pricingTierStorageAccounts')]"
                            },
                            "pricingTierVMs": {
                              "value": "[parameters('pricingTierVMs')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "pricingTierAppServices": {
                                "metadata": {
                                  "description": "pricingTierAppServices"
                                },
                                "type": "string"
                              },
                              "pricingTierContainerRegistry": {
                                "metadata": {
                                  "description": "ContainerRegistry"
                                },
                                "type": "string"
                              },
                              "pricingTierKeyVaults": {
                                "metadata": {
                                  "description": "KeyVaults"
                                },
                                "type": "string"
                              },
                              "pricingTierKubernetesService": {
                                "metadata": {
                                  "description": "KubernetesService"
                                },
                                "type": "string"
                              },
                              "pricingTierSqlServers": {
                                "metadata": {
                                  "description": "pricingTierSqlServers"
                                },
                                "type": "string"
                              },
                              "pricingTierStorageAccounts": {
                                "metadata": {
                                  "description": "pricingTierStorageAccounts"
                                },
                                "type": "string"
                              },
                              "pricingTierVMs": {
                                "metadata": {
                                  "description": "pricingTierVMs"
                                },
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-06-01",
                                "name": "VirtualMachines",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierVMs')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              },
                              {
                                "apiVersion": "2018-06-01",
                                "dependsOn": [
                                  "[concat('Microsoft.Security/pricings/VirtualMachines')]"
                                ],
                                "name": "StorageAccounts",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierStorageAccounts')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              },
                              {
                                "apiVersion": "2018-06-01",
                                "dependsOn": [
                                  "[concat('Microsoft.Security/pricings/StorageAccounts')]"
                                ],
                                "name": "AppServices",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierAppServices')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              },
                              {
                                "apiVersion": "2018-06-01",
                                "dependsOn": [
                                  "[concat('Microsoft.Security/pricings/AppServices')]"
                                ],
                                "name": "SqlServers",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierSqlServers')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              },
                              {
                                "apiVersion": "2018-06-01",
                                "dependsOn": [
                                  "[concat('Microsoft.Security/pricings/SqlServers')]"
                                ],
                                "name": "KeyVaults",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierKeyVaults')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              },
                              {
                                "apiVersion": "2018-06-01",
                                "dependsOn": [
                                  "[concat('Microsoft.Security/pricings/KeyVaults')]"
                                ],
                                "name": "KubernetesService",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierKubernetesService')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              },
                              {
                                "apiVersion": "2018-06-01",
                                "dependsOn": [
                                  "[concat('Microsoft.Security/pricings/KubernetesService')]"
                                ],
                                "name": "ContainerRegistry",
                                "properties": {
                                  "pricingTier": "[parameters('pricingTierContainerRegistry')]"
                                },
                                "type": "Microsoft.Security/pricings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "deploymentScope": "subscription",
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "Standard",
                            "field": "Microsoft.Security/pricings/pricingTier"
                          },
                          {
                            "equals": "Microsoft.Security/pricings",
                            "field": "type"
                          }
                        ]
                      },
                      "existenceScope": "subscription",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
                      ],
                      "type": "Microsoft.Security/pricings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-AzureBackup-on-VM",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-AzureBackup-on-VM",
              "ResourceName": "Deploy-AzureBackup-on-VM",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-AzureBackup-on-VM",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-AzureBackup-on-VMs",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Compute/virtualMachines",
                        "field": "type"
                      },
                      {
                        "anyOf": [
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftWindowsServer",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "WindowsServer",
                                "field": "Microsoft.Compute/imageOffer"
                              },
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "in": [
                                  "2008-R2-SP1",
                                  "2008-R2-SP1-smalldisk",
                                  "2012-Datacenter",
                                  "2012-Datacenter-smalldisk",
                                  "2012-R2-Datacenter",
                                  "2012-R2-Datacenter-smalldisk",
                                  "2016-Datacenter",
                                  "2016-Datacenter-Server-Core",
                                  "2016-Datacenter-Server-Core-smalldisk",
                                  "2016-Datacenter-smalldisk",
                                  "2016-Datacenter-with-Containers",
                                  "2016-Datacenter-with-RDSH",
                                  "2019-Datacenter",
                                  "2019-Datacenter-Core",
                                  "2019-Datacenter-Core-smalldisk",
                                  "2019-Datacenter-Core-with-Containers",
                                  "2019-Datacenter-Core-with-Containers-smalldisk",
                                  "2019-Datacenter-smalldisk",
                                  "2019-Datacenter-with-Containers",
                                  "2019-Datacenter-with-Containers-smalldisk",
                                  "2019-Datacenter-zhcn"
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftWindowsServer",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "WindowsServerSemiAnnual",
                                "field": "Microsoft.Compute/imageOffer"
                              },
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "in": [
                                  "Datacenter-Core-1709-smalldisk",
                                  "Datacenter-Core-1709-with-Containers-smalldisk",
                                  "Datacenter-Core-1803-with-Containers-smalldisk"
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftWindowsServerHPCPack",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "WindowsServerHPCPack",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftSQLServer",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "anyOf": [
                                  {
                                    "field": "Microsoft.Compute/imageOffer",
                                    "like": "*-WS2016"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageOffer",
                                    "like": "*-WS2016-BYOL"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageOffer",
                                    "like": "*-WS2012R2"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageOffer",
                                    "like": "*-WS2012R2-BYOL"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftRServer",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "MLServer-WS2016",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftVisualStudio",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "in": [
                                  "VisualStudio",
                                  "Windows"
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftDynamicsAX",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "Dynamics",
                                "field": "Microsoft.Compute/imageOffer"
                              },
                              {
                                "equals": "Pre-Req-AX7-Onebox-U8",
                                "field": "Microsoft.Compute/imageSKU"
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "microsoft-ads",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "windows-data-science-vm",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "MicrosoftWindowsDesktop",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "Windows-10",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "RedHat",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "in": [
                                  "RHEL",
                                  "RHEL-SAP-HANA"
                                ]
                              },
                              {
                                "anyOf": [
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "6.*"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "7*"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "SUSE",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "in": [
                                  "SLES",
                                  "SLES-HPC",
                                  "SLES-HPC-Priority",
                                  "SLES-SAP",
                                  "SLES-SAP-BYOS",
                                  "SLES-Priority",
                                  "SLES-BYOS",
                                  "SLES-SAPCAL",
                                  "SLES-Standard"
                                ]
                              },
                              {
                                "anyOf": [
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "12*"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "Canonical",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "UbuntuServer",
                                "field": "Microsoft.Compute/imageOffer"
                              },
                              {
                                "anyOf": [
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "14.04*LTS"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "16.04*LTS"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "18.04*LTS"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "Oracle",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "Oracle-Linux",
                                "field": "Microsoft.Compute/imageOffer"
                              },
                              {
                                "anyOf": [
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "6.*"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "7.*"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "OpenLogic",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "in": [
                                  "CentOS",
                                  "Centos-LVM",
                                  "CentOS-SRIOV"
                                ]
                              },
                              {
                                "anyOf": [
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "6.*"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "like": "7*"
                                  }
                                ]
                              }
                            ]
                          },
                          {
                            "allOf": [
                              {
                                "equals": "cloudera",
                                "field": "Microsoft.Compute/imagePublisher"
                              },
                              {
                                "equals": "cloudera-centos-os",
                                "field": "Microsoft.Compute/imageOffer"
                              },
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "like": "7*"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "vmName": {
                              "value": "[field('name')]"
                            },
                            "vmRgName": {
                              "value": "[resourceGroup().name]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {
                              "status": {
                                "type": "string",
                                "value": "[concat('Backup enabled successfully for VM:', ' ', parameters('vmName'))]"
                              }
                            },
                            "parameters": {
                              "location": {
                                "metadata": {
                                  "description": "Location for VM and Backup vault"
                                },
                                "type": "string"
                              },
                              "vmName": {
                                "metadata": {
                                  "description": "Name of Azure Virtual Machines"
                                },
                                "type": "string"
                              },
                              "vmRgName": {
                                "metadata": {
                                  "description": "Resource group containing the virtual machines."
                                },
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2016-06-01",
                                "location": "[parameters('location')]",
                                "name": "[variables('vaultName')]",
                                "properties": {},
                                "sku": {
                                  "name": "Standard"
                                },
                                "type": "Microsoft.RecoveryServices/vaults"
                              },
                              {
                                "apiVersion": "2016-12-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.RecoveryServices/vaults/', variables('vaultName'))]"
                                ],
                                "location": "[parameters('location')]",
                                "name": "[concat(variables('vaultName'), '/', variables('backupFabric'), '/', variables('v2VmContainer'), concat(parameters('vmRgName'),';',parameters('vmName')), '/', variables('v2Vm'), concat(parameters('vmRgName'),';',parameters('vmName')))]",
                                "properties": {
                                  "policyId": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', variables('vaultName'),variables('backupPolicy'))]",
                                  "protectedItemType": "[variables('v2VmType')]",
                                  "sourceResourceId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('vmRgName'), '/providers/Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
                                },
                                "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems"
                              }
                            ],
                            "variables": {
                              "backupFabric": "Azure",
                              "backupPolicy": "DefaultPolicy",
                              "v2Vm": "vm;iaasvmcontainerv2;",
                              "v2VmContainer": "iaasvmcontainer;iaasvmcontainerv2;",
                              "v2VmType": "Microsoft.Compute/virtualMachines",
                              "vaultName": "[concat(resourceGroup().name, '-backupvault')]"
                            }
                          }
                        }
                      },
                      "existenceCondition": {
                        "field": "name",
                        "like": "*"
                      },
                      "resourceGroupName": "[resourceGroup().name]",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.RecoveryServices/backupprotecteditems"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DDoSProtection",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DDoSProtection",
              "ResourceName": "Deploy-DDoSProtection",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DDoSProtection",
              "Properties": {
                "Description": "This policy deploys an Azure DDoS Protection Standard plan",
                "DisplayName": "Deploy-DDoSProtection",
                "Mode": "All",
                "Parameters": {
                  "ddosName": {
                    "type": "String",
                    "metadata": {
                      "description": "Name of the Virtual WAN",
                      "displayName": "ddosName"
                    }
                  },
                  "ddosRegion": {
                    "type": "String",
                    "metadata": {
                      "description": "Select Azure region for Virtual WAN",
                      "displayName": "ddosRegion",
                      "strongType": "location"
                    }
                  },
                  "rgName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for resource group.",
                      "displayName": "rgName"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "ddosname": {
                              "value": "[parameters('ddosname')]"
                            },
                            "ddosregion": {
                              "value": "[parameters('ddosRegion')]"
                            },
                            "rgName": {
                              "value": "[parameters('rgName')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "ddosRegion": {
                                "type": "string"
                              },
                              "ddosname": {
                                "type": "string"
                              },
                              "rgName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-05-01",
                                "location": "[deployment().location]",
                                "name": "[parameters('rgName')]",
                                "properties": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                                ],
                                "name": "ddosprotection",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                                    "contentVersion": "1.0.0.0",
                                    "outputs": {},
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2019-12-01",
                                        "location": "[parameters('ddosRegion')]",
                                        "name": "[parameters('ddosName')]",
                                        "properties": {},
                                        "type": "Microsoft.Network/ddosProtectionPlans"
                                      }
                                    ]
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ]
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceScope": "ResourceGroup",
                      "name": "[parameters('ddosName')]",
                      "resourceGroupName": "[parameters('rgName')]",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/ddosProtectionPlans"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-AA",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AA",
              "ResourceName": "Deploy-Diagnostics-AA",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AA",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Automation Accounts - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-AA",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Automation/automationAccounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "JobLogs",
                                      "enabled": true
                                    },
                                    {
                                      "category": "JobStreams",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DscNodeStatus",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Automation/automationAccounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-ACI",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ACI",
              "ResourceName": "Deploy-Diagnostics-ACI",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ACI",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Container Instances - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-ACI",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.ContainerInstance/containerGroups",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.ContainerInstance/containerGroups/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-ACR",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ACR",
              "ResourceName": "Deploy-Diagnostics-ACR",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ACR",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Container Registries - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-ACR",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.ContainerRegistry/registries",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.ContainerRegistry/registries/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-ActivityLog",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ActivityLog",
              "ResourceName": "Deploy-Diagnostics-ActivityLog",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ActivityLog",
              "Properties": {
                "Description": "Ensures that Activity Log Diagnostics settings are set to push logs into Log Analytics",
                "DisplayName": "Deploy-Diagnostics-ActivityLog",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select Log Analytics workspace from dropdown list",
                      "displayName": "Primary Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "logAnalytics": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "location": "Global",
                                "name": "subscriptionLogsToLogAnalytics",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Administrative",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Security",
                                      "enabled": true
                                    },
                                    {
                                      "category": "ServiceHealth",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Alert",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Recommendation",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Policy",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Autoscale",
                                      "enabled": true
                                    },
                                    {
                                      "category": "ResourceHealth",
                                      "enabled": true
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Insights/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "existenceScope": "Subscription",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-AKS",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AKS",
              "ResourceName": "Deploy-Diagnostics-AKS",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AKS",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Kubernetes Service - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-AKS",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.ContainerService/managedClusters",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "kube-audit",
                                      "enabled": true
                                    },
                                    {
                                      "category": "kube-apiserver",
                                      "enabled": true
                                    },
                                    {
                                      "category": "kube-controller-manager",
                                      "enabled": true
                                    },
                                    {
                                      "category": "kube-scheduler",
                                      "enabled": true
                                    },
                                    {
                                      "category": "cluster-autoscaler",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.ContainerService/managedClusters/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-AnalysisService",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AnalysisService",
              "ResourceName": "Deploy-Diagnostics-AnalysisService",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AnalysisService",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Analysis Services - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-AnalysisService",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.AnalysisServices/servers",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Engine",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Service",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.AnalysisServices/servers/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-APIMgmt",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-APIMgmt",
              "ResourceName": "Deploy-Diagnostics-APIMgmt",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-APIMgmt",
              "Properties": {
                "Description": "Apply diagnostic settings for API Management services - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-APIMgmt",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.ApiManagement/service",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "GatewayLogs",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "Gateway Requests",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    },
                                    {
                                      "category": "Capacity",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    },
                                    {
                                      "category": "EventHub Events",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.ApiManagement/service/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-ApplicationGateway",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ApplicationGateway",
              "ResourceName": "Deploy-Diagnostics-ApplicationGateway",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ApplicationGateway",
              "Properties": {
                "Description": "Apply diagnostic settings for Application Gateways - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-ApplicationGateway",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/applicationGateways",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "ApplicationGatewayAccessLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "ApplicationGatewayPerformanceLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "ApplicationGatewayFirewallLog",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/applicationGateways/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-Batch",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Batch",
              "ResourceName": "Deploy-Diagnostics-Batch",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Batch",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Batch accounts - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-Batch",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Batch/batchAccounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "ServiceLog",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Batch/batchAccounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-CDNEndpoints",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CDNEndpoints",
              "ResourceName": "Deploy-Diagnostics-CDNEndpoints",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CDNEndpoints",
              "Properties": {
                "Description": "Apply diagnostic settings for CDN Endpoints - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-CDNEndpoints",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Cdn/profiles/endpoints",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('fullName')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "CoreAnalytics",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Cdn/profiles/endpoints/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-CognitiveServices",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CognitiveServices",
              "ResourceName": "Deploy-Diagnostics-CognitiveServices",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CognitiveServices",
              "Properties": {
                "Description": "Apply diagnostic settings for Cognitive Services - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-CognitiveServices",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.CognitiveServices/accounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Audit",
                                      "enabled": true
                                    },
                                    {
                                      "category": "RequestResponse",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.CognitiveServices/accounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-CosmosDB",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CosmosDB",
              "ResourceName": "Deploy-Diagnostics-CosmosDB",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CosmosDB",
              "Properties": {
                "Description": "Apply diagnostic settings for Cosmos DB - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-CosmosDB",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.DocumentDB/databaseAccounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "DataPlaneRequests",
                                      "enabled": true
                                    },
                                    {
                                      "category": "MongoRequests",
                                      "enabled": true
                                    },
                                    {
                                      "category": "QueryRuntimeStatistics",
                                      "enabled": true
                                    },
                                    {
                                      "category": "PartitionKeyStatistics",
                                      "enabled": true
                                    },
                                    {
                                      "category": "PartitionKeyRUConsumption",
                                      "enabled": true
                                    },
                                    {
                                      "category": "ControlPlaneRequests",
                                      "enabled": true
                                    },
                                    {
                                      "category": "CassandraRequests",
                                      "enabled": true
                                    },
                                    {
                                      "category": "GremlinRequests",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "Requests",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.DocumentDB/databaseAccounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-DataFactory",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DataFactory",
              "ResourceName": "Deploy-Diagnostics-DataFactory",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DataFactory",
              "Properties": {
                "Description": "Apply diagnostic settings for Data Factory - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-DataFactory",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.DataFactory/factories",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "ActivityRuns",
                                      "enabled": true
                                    },
                                    {
                                      "category": "PipelineRuns",
                                      "enabled": true
                                    },
                                    {
                                      "category": "TriggerRuns",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.DataFactory/factories/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-DataLakeStore",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DataLakeStore",
              "ResourceName": "Deploy-Diagnostics-DataLakeStore",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DataLakeStore",
              "Properties": {
                "Description": "Apply diagnostic settings for Data Lake Storage - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-DataLakeStore",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.DataLakeStore/accounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Audit",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Requests",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.DataLakeStore/accounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-DLAnalytics",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DLAnalytics",
              "ResourceName": "Deploy-Diagnostics-DLAnalytics",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DLAnalytics",
              "Properties": {
                "Description": "Apply diagnostic settings for Data Lake Analytics - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-DLAnalytics",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.DataLakeAnalytics/accounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Audit",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Requests",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.DataLakeAnalytics/accounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-EventGridSub",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventGridSub",
              "ResourceName": "Deploy-Diagnostics-EventGridSub",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventGridSub",
              "Properties": {
                "Description": "Apply diagnostic settings for Event Grid Subscriptions - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-EventGridSub",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.EventGrid/eventSubscriptions",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.EventGrid/eventSubscriptions/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-EventGridTopic",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventGridTopic",
              "ResourceName": "Deploy-Diagnostics-EventGridTopic",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventGridTopic",
              "Properties": {
                "Description": "Apply diagnostic settings for Event Grid Topics - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-EventGridTopic",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.EventGrid/topics",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.EventGrid/topics/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-EventHub",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventHub",
              "ResourceName": "Deploy-Diagnostics-EventHub",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventHub",
              "Properties": {
                "Description": "Apply diagnostic settings for Event Hub Namespaces - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-EventHub",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.EventHub/namespaces",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "ArchiveLogs",
                                      "enabled": true
                                    },
                                    {
                                      "category": "OperationalLogs",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AutoScaleLogs",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.EventHub/namespaces/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-ExpressRoute",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ExpressRoute",
              "ResourceName": "Deploy-Diagnostics-ExpressRoute",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ExpressRoute",
              "Properties": {
                "Description": "Apply diagnostic settings for Express Routes Circuits - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-ExpressRoute",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/expressRouteCircuits",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "PeeringRouteLog",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/expressRouteCircuits/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-Firewall",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Firewall",
              "ResourceName": "Deploy-Diagnostics-Firewall",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Firewall",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Firewalls - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-Firewall",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/azureFirewalls",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "AzureFirewallApplicationRule",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AzureFirewallNetworkRule",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/azureFirewalls/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-HDInsight",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-HDInsight",
              "ResourceName": "Deploy-Diagnostics-HDInsight",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-HDInsight",
              "Properties": {
                "Description": "Apply diagnostic settings for HDInsight - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-HDInsight",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.HDInsight/clusters",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.HDInsight/clusters/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-iotHub",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-iotHub",
              "ResourceName": "Deploy-Diagnostics-iotHub",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-iotHub",
              "Properties": {
                "Description": "Apply diagnostic settings for IoT Hubs - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-iotHub",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Devices/IotHubs",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Connections",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DeviceTelemetry",
                                      "enabled": true
                                    },
                                    {
                                      "category": "C2DCommands",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DeviceIdentityOperations",
                                      "enabled": true
                                    },
                                    {
                                      "category": "FileUploadOperations",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Routes",
                                      "enabled": true
                                    },
                                    {
                                      "category": "D2CTwinOperations",
                                      "enabled": true
                                    },
                                    {
                                      "category": "C2DTwinOperations",
                                      "enabled": true
                                    },
                                    {
                                      "category": "TwinQueries",
                                      "enabled": true
                                    },
                                    {
                                      "category": "JobsOperations",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DirectMethods",
                                      "enabled": true
                                    },
                                    {
                                      "category": "E2EDiagnostics",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Configurations",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Devices/IotHubs/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-KeyVault",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-KeyVault",
              "ResourceName": "Deploy-Diagnostics-KeyVault",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-KeyVault",
              "Properties": {
                "Description": "Apply diagnostic settings for Key Vaults - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-KeyVault",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.KeyVault/vaults",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "AuditEvent",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.KeyVault/vaults/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-LoadBalancer",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LoadBalancer",
              "ResourceName": "Deploy-Diagnostics-LoadBalancer",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LoadBalancer",
              "Properties": {
                "Description": "Apply diagnostic settings for Load Balancers - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-LoadBalancer",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/loadBalancers",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "LoadBalancerAlertEvent",
                                      "enabled": true
                                    },
                                    {
                                      "category": "LoadBalancerProbeHealthStatus",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/loadBalancers/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-LogicAppsISE",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LogicAppsISE",
              "ResourceName": "Deploy-Diagnostics-LogicAppsISE",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LogicAppsISE",
              "Properties": {
                "Description": "Apply diagnostic settings for Logic Apps Integration Accounts - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-LogicAppsISE",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Logic/integrationAccounts",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "IntegrationAccountTrackingEvents",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Logic/integrationAccounts/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-LogicAppsWF",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LogicAppsWF",
              "ResourceName": "Deploy-Diagnostics-LogicAppsWF",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LogicAppsWF",
              "Properties": {
                "Description": "Apply diagnostic settings for Logic Apps workflows - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-LogicAppsWF",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Logic/workflows",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "WorkflowRuntime",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Logic/workflows/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-MlWorkspace",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-MlWorkspace",
              "ResourceName": "Deploy-Diagnostics-MlWorkspace",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-MlWorkspace",
              "Properties": {
                "Description": "Apply diagnostic settings for Ml Workspace - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-MlWorkspace",
                "Mode": "Indexed",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.MachineLearningServices/workspaces",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "AmlComputeClusterEvent",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AmlComputeClusterNodeEvent",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AmlComputeJobEvent",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AmlComputeCpuGpuUtilization",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AmlRunStatusChangedEvent",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "Run",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    },
                                    {
                                      "category": "Model",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": true
                                      }
                                    },
                                    {
                                      "category": "Quota",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    },
                                    {
                                      "category": "Resource",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.MachineLearningServices/workspaces/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-MySQL",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-MySQL",
              "ResourceName": "Deploy-Diagnostics-MySQL",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-MySQL",
              "Properties": {
                "Description": "Apply diagnostic settings for MySQL Databases - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-MySQL",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.DBforMySQL/servers",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "MySqlSlowLogs",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.DBforMySQL/servers/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-NetworkSecurityGroups",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-NetworkSecurityGroups",
              "ResourceName": "Deploy-Diagnostics-NetworkSecurityGroups",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-NetworkSecurityGroups",
              "Properties": {
                "Description": "Apply diagnostic settings for Network Security Groups - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-NetworkSecurityGroups",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/networkSecurityGroups",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "NetworkSecurityGroupEvent",
                                      "enabled": true
                                    },
                                    {
                                      "category": "NetworkSecurityGroupRuleCounter",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/networkSecurityGroups/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-NIC",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-NIC",
              "ResourceName": "Deploy-Diagnostics-NIC",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-NIC",
              "Properties": {
                "Description": "Apply diagnostic settings for Network Interfaces - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-NIC",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/networkInterfaces",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/networkInterfaces/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-PostgreSQL",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PostgreSQL",
              "ResourceName": "Deploy-Diagnostics-PostgreSQL",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PostgreSQL",
              "Properties": {
                "Description": "Apply diagnostic settings for PostgreSQL Databases - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-PostgreSQL",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.DBforPostgreSQL/servers",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "PostgreSQLLogs",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.DBforPostgreSQL/servers/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-PowerBIEmbedded",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PowerBIEmbedded",
              "ResourceName": "Deploy-Diagnostics-PowerBIEmbedded",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PowerBIEmbedded",
              "Properties": {
                "Description": "Apply diagnostic settings for Power BI Embedded - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-PowerBIEmbedded",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.PowerBIDedicated/capacities",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Engine",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.PowerBIDedicated/capacities/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-PublicIP",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PublicIP",
              "ResourceName": "Deploy-Diagnostics-PublicIP",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PublicIP",
              "Properties": {
                "Description": "Apply diagnostic settings for Public IPs - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-PublicIP",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/publicIPAddresses",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "DDoSProtectionNotifications",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DDoSMitigationFlowLogs",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DDoSMitigationReports",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/publicIPAddresses/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-RecoveryVault",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-RecoveryVault",
              "ResourceName": "Deploy-Diagnostics-RecoveryVault",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-RecoveryVault",
              "Properties": {
                "Description": "Apply diagnostic settings for Recovery Vaults - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-RecoveryVault",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.RecoveryServices/vaults",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', 'setByPolicy')]",
                                "properties": {
                                  "logAnalyticsDestinationType": "Dedicated",
                                  "logs": [
                                    {
                                      "category": "CoreAzureBackup",
                                      "enabled": "true"
                                    },
                                    {
                                      "category": "AddonAzureBackupAlerts",
                                      "enabled": "true"
                                    },
                                    {
                                      "category": "AddonAzureBackupJobs",
                                      "enabled": "true"
                                    },
                                    {
                                      "category": "AddonAzureBackupPolicy",
                                      "enabled": "true"
                                    },
                                    {
                                      "category": "AddonAzureBackupProtectedInstance",
                                      "enabled": "true"
                                    },
                                    {
                                      "category": "AddonAzureBackupStorage",
                                      "enabled": "true"
                                    }
                                  ],
                                  "metrics": [],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.RecoveryServices/vaults/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allof": [
                          {
                            "Equals": 6,
                            "count": {
                              "field": "Microsoft.Insights/diagnosticSettings/logs[*]",
                              "where": {
                                "allof": [
                                  {
                                    "field": "Microsoft.Insights/diagnosticSettings/logs[*].Category",
                                    "in": [
                                      "CoreAzureBackup",
                                      "AddonAzureBackupJobs",
                                      "AddonAzureBackupAlerts",
                                      "AddonAzureBackupPolicy",
                                      "AddonAzureBackupStorage",
                                      "AddonAzureBackupProtectedInstance"
                                    ]
                                  },
                                  {
                                    "equals": "True",
                                    "field": "Microsoft.Insights/diagnosticSettings/logs[*].Enabled"
                                  }
                                ]
                              }
                            }
                          },
                          {
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                            "notEquals": "[parameters('logAnalytics')]"
                          },
                          {
                            "equals": "Dedicated",
                            "field": "Microsoft.Insights/diagnosticSettings/logAnalyticsDestinationType"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-RedisCache",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-RedisCache",
              "ResourceName": "Deploy-Diagnostics-RedisCache",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-RedisCache",
              "Properties": {
                "Description": "Apply diagnostic settings for Redis Cache - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-RedisCache",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Cache/redis",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Cache/redis/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-Relay",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Relay",
              "ResourceName": "Deploy-Diagnostics-Relay",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Relay",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Relay - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-Relay",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Relay/namespaces",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Relay/namespaces/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-SearchServices",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SearchServices",
              "ResourceName": "Deploy-Diagnostics-SearchServices",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SearchServices",
              "Properties": {
                "Description": "Apply diagnostic settings for Search Services - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-SearchServices",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Search/searchServices",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "OperationLogs",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Search/searchServices/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-ServiceBus",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ServiceBus",
              "ResourceName": "Deploy-Diagnostics-ServiceBus",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ServiceBus",
              "Properties": {
                "Description": "Apply diagnostic settings for Service Bus namespaces - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-ServiceBus",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.ServiceBus/namespaces",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "OperationalLogs",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.ServiceBus/namespaces/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-SignalR",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SignalR",
              "ResourceName": "Deploy-Diagnostics-SignalR",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SignalR",
              "Properties": {
                "Description": "Apply diagnostic settings for SignalR - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-SignalR",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.SignalRService/SignalR",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.SignalRService/SignalR/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-SQLDBs",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLDBs",
              "ResourceName": "Deploy-Diagnostics-SQLDBs",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLDBs",
              "Properties": {
                "Description": "Apply diagnostic settings for SQL Databases - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-SQLDBs",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/servers/databases",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('fullName')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "SQLInsights",
                                      "enabled": true
                                    },
                                    {
                                      "category": "AutomaticTuning",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DevOpsOperationsAudit",
                                      "enabled": true
                                    },
                                    {
                                      "category": "QueryStoreRuntimeStatistics",
                                      "enabled": true
                                    },
                                    {
                                      "category": "QueryStoreWaitStatistics",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Errors",
                                      "enabled": true
                                    },
                                    {
                                      "category": "DatabaseWaitStatistics",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Timeouts",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Blocks",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Deadlocks",
                                      "enabled": true
                                    },
                                    {
                                      "category": "SQLSecurityAuditEvents",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Sql/servers/databases/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-SQLElasticPools",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLElasticPools",
              "ResourceName": "Deploy-Diagnostics-SQLElasticPools",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLElasticPools",
              "Properties": {
                "Description": "Apply diagnostic settings for SQL Elastic Pools - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-SQLElasticPools",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/servers/elasticPools",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('fullName')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Sql/servers/elasticPools/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-SQLMI",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLMI",
              "ResourceName": "Deploy-Diagnostics-SQLMI",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLMI",
              "Properties": {
                "Description": "Apply diagnostic settings for SQL Managed Instances - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-SQLMI",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/managedInstances",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "ResourceUsageStats",
                                      "enabled": true
                                    },
                                    {
                                      "category": "SQLSecurityAuditEvents",
                                      "enabled": true
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Sql/managedInstances/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-StreamAnalytics",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-StreamAnalytics",
              "ResourceName": "Deploy-Diagnostics-StreamAnalytics",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-StreamAnalytics",
              "Properties": {
                "Description": "Apply diagnostic settings for Stream Analytics - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-StreamAnalytics",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.StreamAnalytics/streamingjobs",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "Execution",
                                      "enabled": true
                                    },
                                    {
                                      "category": "Authoring",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.StreamAnalytics/streamingjobs/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-TimeSeriesInsights",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-TimeSeriesInsights",
              "ResourceName": "Deploy-Diagnostics-TimeSeriesInsights",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-TimeSeriesInsights",
              "Properties": {
                "Description": "Apply diagnostic settings for Time Series Insights - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-TimeSeriesInsights",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.TimeSeriesInsights/environments",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.TimeSeriesInsights/environments/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-TrafficManager",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-TrafficManager",
              "ResourceName": "Deploy-Diagnostics-TrafficManager",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-TrafficManager",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Traffic Manager - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-TrafficManager",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/trafficManagerProfiles",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "ProbeHealthStatusEvents",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/trafficManagerProfiles/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-VirtualNetwork",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VirtualNetwork",
              "ResourceName": "Deploy-Diagnostics-VirtualNetwork",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VirtualNetwork",
              "Properties": {
                "Description": "Apply diagnostic settings for Virtual Networks - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-VirtualNetwork",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/virtualNetworks",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "VMProtectionAlerts",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/virtualNetworks/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-VM",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VM",
              "ResourceName": "Deploy-Diagnostics-VM",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VM",
              "Properties": {
                "Description": "Apply diagnostic settings for Virtual Machines - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-VM",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Compute/virtualMachines",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Compute/virtualMachines/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-VMSS",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VMSS",
              "ResourceName": "Deploy-Diagnostics-VMSS",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VMSS",
              "Properties": {
                "Description": "Apply diagnostic settings for Virtual Machine Scale Sets - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-VMSS",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Compute/virtualMachineScaleSets",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Compute/virtualMachineScaleSets/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-VNetGW",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VNetGW",
              "ResourceName": "Deploy-Diagnostics-VNetGW",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VNetGW",
              "Properties": {
                "Description": "Apply diagnostic settings for Virtual Network Gateways - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-VNetGW",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/virtualNetworkGateways",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [
                                    {
                                      "category": "GatewayDiagnosticLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "IKEDiagnosticLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "P2SDiagnosticLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "RouteDiagnosticLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "RouteDiagnosticLog",
                                      "enabled": true
                                    },
                                    {
                                      "category": "TunnelDiagnosticLog",
                                      "enabled": true
                                    }
                                  ],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Network/virtualNetworkGateways/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/logs.enabled"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-WebServerFarm",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-WebServerFarm",
              "ResourceName": "Deploy-Diagnostics-WebServerFarm",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-WebServerFarm",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure App Service Plans - Log Analytics",
                "DisplayName": "Deploy-Diagnostics-WebServerFarm",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Web/serverfarms",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Web/serverfarms/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Diagnostics-Website",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Website",
              "ResourceName": "Deploy-Diagnostics-Website",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Website",
              "Properties": {
                "Description": "Apply diagnostic settings for Azure Web Sites",
                "DisplayName": "Deploy-Diagnostics-Website",
                "Mode": "All",
                "Parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Web/sites",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "logAnalytics": {
                              "value": "[parameters('logAnalytics')]"
                            },
                            "resourceName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "logAnalytics": {
                                "type": "string"
                              },
                              "resourceName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-05-01-preview",
                                "dependsOn": [],
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('resourceName'), '/', 'Microsoft.Insights/setByPolicy')]",
                                "properties": {
                                  "logs": [],
                                  "metrics": [
                                    {
                                      "category": "AllMetrics",
                                      "enabled": true,
                                      "retentionPolicy": {
                                        "days": 0,
                                        "enabled": false
                                      }
                                    }
                                  ],
                                  "workspaceId": "[parameters('logAnalytics')]"
                                },
                                "type": "Microsoft.Web/sites/providers/diagnosticSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "true",
                            "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled"
                          },
                          {
                            "equals": "[parameters('logAnalytics')]",
                            "field": "Microsoft.Insights/diagnosticSettings/workspaceId"
                          }
                        ]
                      },
                      "name": "setByPolicy",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Insights/diagnosticSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DNSZoneGroup-For-Blob-PrivateEndpoint",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Blob-PrivateEndpoint",
              "ResourceName": "Deploy-DNSZoneGroup-For-Blob-PrivateEndpoint",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Blob-PrivateEndpoint",
              "Properties": {
                "Description": "Deploys a DNS Zone Group for Storage-Blob Private Endpoint",
                "DisplayName": "Deploy-DNSZoneGroup-For-Blob-PrivateEndpoint",
                "Mode": "Indexed",
                "Parameters": {
                  "privateDnsZoneId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "privateDnsZoneId",
                      "strongType": "Microsoft.Network/privateDnsZones"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/privateEndpoints",
                        "field": "type"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "equals": "blob",
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "privateDnsZoneId": {
                              "value": "[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-03-01",
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "storageBlob-privateDnsZone",
                                      "properties": {
                                        "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                },
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                              }
                            ]
                          }
                        }
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DNSZoneGroup-For-File-PrivateEndpoint",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-File-PrivateEndpoint",
              "ResourceName": "Deploy-DNSZoneGroup-For-File-PrivateEndpoint",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-File-PrivateEndpoint",
              "Properties": {
                "Description": "This policy deploys a DNS Zone Group for Storage-File Private Endpoint",
                "DisplayName": "Deploy-DNSZoneGroup-For-File-PrivateEndpoint",
                "Mode": "Indexed",
                "Parameters": {
                  "privateDnsZoneId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "privateDnsZoneId",
                      "strongType": "Microsoft.Network/privateDnsZones"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/privateEndpoints",
                        "field": "type"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "equals": "file",
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "privateDnsZoneId": {
                              "value": "[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-03-01",
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "storageFile-privateDnsZone",
                                      "properties": {
                                        "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                },
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                              }
                            ]
                          }
                        }
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DNSZoneGroup-For-KeyVault-PrivateEndpoint",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-KeyVault-PrivateEndpoint",
              "ResourceName": "Deploy-DNSZoneGroup-For-KeyVault-PrivateEndpoint",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-KeyVault-PrivateEndpoint",
              "Properties": {
                "Description": "This policy deploys a DNS Zone Group for Key Vault Private Endpoint",
                "DisplayName": "Deploy-DNSZoneGroup-For-KeyVault-PrivateEndpoint",
                "Mode": "Indexed",
                "Parameters": {
                  "privateDnsZoneId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "privateDnsZoneId",
                      "strongType": "Microsoft.Network/privateDnsZones"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/privateEndpoints",
                        "field": "type"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "equals": "vault",
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "privateDnsZoneId": {
                              "value": "[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-03-01",
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "keyVault-privateDnsZone",
                                      "properties": {
                                        "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                },
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                              }
                            ]
                          }
                        }
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DNSZoneGroup-For-Queue-PrivateEndpoint",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Queue-PrivateEndpoint",
              "ResourceName": "Deploy-DNSZoneGroup-For-Queue-PrivateEndpoint",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Queue-PrivateEndpoint",
              "Properties": {
                "Description": "This policy deploys a DNS Zone Group for Storage-Queue Private Endpoint",
                "DisplayName": "Deploy-DNSZoneGroup-For-Queue-PrivateEndpoint",
                "Mode": "Indexed",
                "Parameters": {
                  "privateDnsZoneId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "privateDnsZoneId",
                      "strongType": "Microsoft.Network/privateDnsZones"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/privateEndpoints",
                        "field": "type"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "equals": "queue",
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "privateDnsZoneId": {
                              "value": "[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-03-01",
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "storageQueue-privateDnsZone",
                                      "properties": {
                                        "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                },
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                              }
                            ]
                          }
                        }
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DNSZoneGroup-For-Sql-PrivateEndpoint",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Sql-PrivateEndpoint",
              "ResourceName": "Deploy-DNSZoneGroup-For-Sql-PrivateEndpoint",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Sql-PrivateEndpoint",
              "Properties": {
                "Description": "This policy deploys a DNS Zone Group for SQL Private Endpoint",
                "DisplayName": "Deploy-DNSZoneGroup-For-Sql-PrivateEndpoint",
                "Mode": "Indexed",
                "Parameters": {
                  "privateDnsZoneId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "privateDnsZoneId",
                      "strongType": "Microsoft.Network/privateDnsZones"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/privateEndpoints",
                        "field": "type"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "equals": "sqlServer",
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "privateDnsZoneId": {
                              "value": "[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-03-01",
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "sqlServer-privateDnsZone",
                                      "properties": {
                                        "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                },
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                              }
                            ]
                          }
                        }
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-DNSZoneGroup-For-Table-PrivateEndpoint",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Table-PrivateEndpoint",
              "ResourceName": "Deploy-DNSZoneGroup-For-Table-PrivateEndpoint",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-DNSZoneGroup-For-Table-PrivateEndpoint",
              "Properties": {
                "Description": "This policy deploys a DNS Zone Group for Storage-Blob Private Endpoint",
                "DisplayName": "Deploy-DNSZoneGroup-For-Table-PrivateEndpoint",
                "Mode": "Indexed",
                "Parameters": {
                  "privateDnsZoneId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "privateDnsZoneId",
                      "strongType": "Microsoft.Network/privateDnsZones"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Network/privateEndpoints",
                        "field": "type"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "equals": "table",
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "privateDnsZoneId": {
                              "value": "[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-03-01",
                                "location": "[parameters('location')]",
                                "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "storageTable-privateDnsZone",
                                      "properties": {
                                        "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                },
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                              }
                            ]
                          }
                        }
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-FirewallPolicy",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-FirewallPolicy",
              "ResourceName": "Deploy-FirewallPolicy",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-FirewallPolicy",
              "Properties": {
                "Description": "Deploys Azure Firewall Policy/Manager",
                "DisplayName": "Deploy-FirewallPolicy",
                "Mode": "All",
                "Parameters": {
                  "fwPolicyRegion": {
                    "type": "String",
                    "metadata": {
                      "description": "Select Azure region for Azure Firewall Policy",
                      "displayName": "fwPolicyRegion",
                      "strongType": "location"
                    }
                  },
                  "fwpolicy": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing Azure Firewall Policy",
                      "displayName": "fwpolicy"
                    },
                    "defaultValue": {}
                  },
                  "rgName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for resource group.",
                      "displayName": "rgName"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "fwPolicy": {
                              "value": "[parameters('fwPolicy')]"
                            },
                            "fwPolicyRegion": {
                              "value": "[parameters('fwPolicyRegion')]"
                            },
                            "rgName": {
                              "value": "[parameters('rgName')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "fwPolicy": {
                                "type": "object"
                              },
                              "fwPolicyRegion": {
                                "type": "string"
                              },
                              "rgName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-05-01",
                                "location": "[deployment().location]",
                                "name": "[parameters('rgName')]",
                                "properties": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                                ],
                                "name": "fwpolicies",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                                    "contentVersion": "1.0.0.0",
                                    "outputs": {},
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2019-09-01",
                                        "dependsOn": [],
                                        "location": "[parameters('fwpolicy').location]",
                                        "name": "[parameters('fwpolicy').firewallPolicyName]",
                                        "properties": {},
                                        "resources": [
                                          {
                                            "apiVersion": "2019-09-01",
                                            "dependsOn": [
                                              "[resourceId('Microsoft.Network/firewallPolicies',parameters('fwpolicy').firewallPolicyName)]"
                                            ],
                                            "name": "[parameters('fwpolicy').ruleGroups.name]",
                                            "properties": {
                                              "priority": "[parameters('fwpolicy').ruleGroups.properties.priority]",
                                              "rules": "[parameters('fwpolicy').ruleGroups.properties.rules]"
                                            },
                                            "type": "ruleGroups"
                                          }
                                        ],
                                        "tags": {},
                                        "type": "Microsoft.Network/firewallPolicies"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ]
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceScope": "ResourceGroup",
                      "resourceGroupName": "[parameters('rgName')]",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/firewallPolicies"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-HUB",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-HUB",
              "ResourceName": "Deploy-HUB",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-HUB",
              "Properties": {
                "Description": "Deploys Azure VNet to be used as hub virtual network in desired regions",
                "DisplayName": "Deploy-HUB",
                "Mode": "All",
                "Parameters": {
                  "HUB": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing HUB",
                      "displayName": "HUB"
                    }
                  },
                  "azfw": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing ExpressRoute gateway",
                      "displayName": "ergw"
                    },
                    "defaultValue": {}
                  },
                  "ergw": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing ExpressRoute gateway",
                      "displayName": "ergw"
                    },
                    "defaultValue": {}
                  },
                  "hubName": {
                    "type": "String",
                    "metadata": {
                      "description": "Name of the Hub",
                      "displayName": "hubName"
                    }
                  },
                  "rgName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for resource group.",
                      "displayName": "rgName"
                    }
                  },
                  "vpngw": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing VPN gateway",
                      "displayName": "vpngw"
                    },
                    "defaultValue": {}
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "ResourceGroupName": "[parameters('rgName')]",
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "HUB": {
                              "value": "[parameters('HUB')]"
                            },
                            "azfw": {
                              "value": "[parameters('azfw')]"
                            },
                            "ergw": {
                              "value": "[parameters('ergw')]"
                            },
                            "hubName": {
                              "value": "[parameters('hubName')]"
                            },
                            "rgName": {
                              "value": "[parameters('rgName')]"
                            },
                            "vpngw": {
                              "value": "[parameters('vpngw')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "HUB": {
                                "metadata": {
                                  "description": "Object describing HUB"
                                },
                                "type": "object"
                              },
                              "azfw": {
                                "defaultValue": {},
                                "metadata": {
                                  "description": "Object describing the Azure Firewall"
                                },
                                "type": "object"
                              },
                              "ergw": {
                                "defaultValue": {},
                                "metadata": {
                                  "description": "Object describing ExpressRoute gateway"
                                },
                                "type": "object"
                              },
                              "hubName": {
                                "metadata": {
                                  "description": "Name of the HUB"
                                },
                                "type": "string"
                              },
                              "rgName": {
                                "metadata": {
                                  "description": "Provide name for resource group.",
                                  "displayName": "rgName"
                                },
                                "type": "String"
                              },
                              "vpngw": {
                                "defaultValue": {},
                                "metadata": {
                                  "description": "Object describing VPN gateway"
                                },
                                "type": "object"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-06-01",
                                "location": "[deployment().location]",
                                "name": "[parameters('rgName')]",
                                "properties": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2020-06-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                                ],
                                "name": "[concat(parameters('hubName'),'-', parameters('HUB').location)]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https: //schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-04-01",
                                        "location": "[parameters('HUB').location]",
                                        "name": "[parameters('hubName')]",
                                        "properties": {
                                          "addressSpace": {
                                            "addressPrefixes": [
                                              "[parameters('HUB').addressPrefix]"
                                            ]
                                          },
                                          "subnets": [
                                            {
                                              "name": "Infrastructure",
                                              "properties": {
                                                "addressPrefix": "[if(not(empty(parameters('HUB').subnets.infra)),parameters('HUB').subnets.infra, json('null'))]"
                                              }
                                            },
                                            {
                                              "name": "AzureFirewallSubnet",
                                              "properties": {
                                                "addressPrefix": "[if(not(empty(parameters('HUB').subnets.azfw)),parameters('HUB').subnets.azfw, json('null'))]"
                                              }
                                            },
                                            {
                                              "name": "GatewaySubnet",
                                              "properties": {
                                                "addressPrefix": "[if(not(empty(parameters('HUB').subnets.gw)),parameters('HUB').subnets.gw, json('null'))]"
                                              }
                                            }
                                          ]
                                        },
                                        "type": "Microsoft.Network/virtualNetworks"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              },
                              {
                                "apiVersion": "2020-06-01",
                                "condition": "[greater(length(parameters('vpngw')),0)]",
                                "dependsOn": [
                                  "[concat(parameters('hubName'),'-', parameters('HUB').location)]"
                                ],
                                "name": "[concat(parameters('hubName'),'-vpngw')]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('HUB').location]",
                                        "name": "[concat(parameters('vpngw').name,'-pip')]",
                                        "properties": {
                                          "publicIPAllocationMethod": "Dynamic"
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Network/publicIpAddresses"
                                      },
                                      {
                                        "apiVersion": "2020-05-01",
                                        "dependsOn": [
                                          "[concat('Microsoft.Network/publicIPAddresses/', parameters('vpngw').name,'-pip')]"
                                        ],
                                        "location": "[parameters('HUB').location]",
                                        "name": "[parameters('vpngw').name]",
                                        "properties": {
                                          "gatewayType": "Vpn",
                                          "ipConfigurations": [
                                            {
                                              "name": "default",
                                              "properties": {
                                                "privateIPAllocationMethod": "Dynamic",
                                                "publicIpAddress": {
                                                  "id": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'), '/providers','/Microsoft.Network/publicIPAddresses/', parameters('vpngw').name,'-pip')]"
                                                },
                                                "subnet": {
                                                  "id": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'), '/providers','/Microsoft.Network/virtualNetworks/', parameters('hubName'),'/subnets/GatewaySubnet')]"
                                                }
                                              }
                                            }
                                          ],
                                          "sku": {
                                            "name": "[parameters('vpngw').sku]",
                                            "tier": "[parameters('vpngw').sku]"
                                          },
                                          "vpnType": "[parameters('vpngw').vpnType]"
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Network/virtualNetworkGateways"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              },
                              {
                                "apiVersion": "2020-06-01",
                                "condition": "[greater(length(parameters('ergw')),0)]",
                                "dependsOn": [
                                  "[concat(parameters('hubName'),'-', parameters('HUB').location)]"
                                ],
                                "name": "[concat(parameters('hubName'),'-ergw')]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('HUB').location]",
                                        "name": "[concat(parameters('ergw').name,'-pip')]",
                                        "properties": {
                                          "publicIPAllocationMethod": "Dynamic"
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Network/publicIpAddresses"
                                      },
                                      {
                                        "apiVersion": "2020-05-01",
                                        "dependsOn": [
                                          "[concat('Microsoft.Network/publicIPAddresses/', parameters('ergw').name,'-pip')]"
                                        ],
                                        "location": "[parameters('HUB').location]",
                                        "name": "[parameters('ergw').name]",
                                        "properties": {
                                          "gatewayType": "ExpressRoute",
                                          "ipConfigurations": [
                                            {
                                              "name": "default",
                                              "properties": {
                                                "privateIPAllocationMethod": "Dynamic",
                                                "publicIpAddress": {
                                                  "id": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'), '/providers','/Microsoft.Network/publicIPAddresses/', parameters('ergw').name,'-pip')]"
                                                },
                                                "subnet": {
                                                  "id": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'), '/providers','/Microsoft.Network/virtualNetworks/', parameters('hubName'),'/subnets/GatewaySubnet')]"
                                                }
                                              }
                                            }
                                          ],
                                          "sku": {
                                            "name": "[parameters('ergw').sku]",
                                            "tier": "[parameters('ergw').sku]"
                                          }
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Network/virtualNetworkGateways"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              },
                              {
                                "apiVersion": "2020-06-01",
                                "condition": "[greater(length(parameters('azfw')),0)]",
                                "dependsOn": [
                                  "[concat(parameters('hubName'),'-', parameters('HUB').location)]"
                                ],
                                "name": "[concat(parameters('hubName'),'-azfw')]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('azfw').location]",
                                        "name": "[concat(parameters('azfw').name,'-pip')]",
                                        "properties": {
                                          "publicIPAllocationMethod": "Static"
                                        },
                                        "sku": {
                                          "name": "Standard"
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Network/publicIpAddresses",
                                        "zones": "[if(contains(parameters('azfw'),'pipZones'),parameters('azfw').pipZones,json('null'))]"
                                      },
                                      {
                                        "apiVersion": "2020-05-01",
                                        "dependsOn": [
                                          "[concat(parameters('azfw').name,'-pip')]"
                                        ],
                                        "location": "[parameters('azfw').location]",
                                        "name": "[parameters('azfw').name]",
                                        "properties": {
                                          "additionalProperties": "[if(contains(parameters('azfw'),'additionalProperties'),parameters('azfw').additionalProperties,json('null'))]",
                                          "firewallPolicy": "[if(contains(parameters('azfw'),'firewallPolicy'),parameters('azfw').firewallPolicy,json('null'))]",
                                          "ipConfigurations": [
                                            {
                                              "name": "[concat(parameters('azfw').name,'-pip')]",
                                              "properties": {
                                                "publicIPAddress": {
                                                  "id": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'), '/providers','/Microsoft.Network/publicIPAddresses/', parameters('azfw').name,'-pip')]"
                                                },
                                                "subnet": {
                                                  "id": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'), '/providers','/Microsoft.Network/virtualNetworks/', parameters('hubName'),'/subnets/AzureFirewallSubnet')]"
                                                }
                                              }
                                            }
                                          ],
                                          "sku": "[if(contains(parameters('azfw'),'sku'),parameters('azfw').sku,json('null'))]",
                                          "threatIntelMode": "[parameters('azfw').threatIntelMode]"
                                        },
                                        "tags": {},
                                        "type": "Microsoft.Network/azureFirewalls",
                                        "zones": "[if(contains(parameters('azfw'),'fwZones'),parameters('azfw').fwZones,json('null'))]"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceScope": "ResourceGroup",
                      "name": "[parameters('hubName')]",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/virtualNetworks"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-LA-Config",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-LA-Config",
              "ResourceName": "Deploy-LA-Config",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-LA-Config",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-LA-Config",
                "Mode": "All",
                "Parameters": {
                  "workspaceName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name of existing Log Analytics workspace",
                      "displayName": "workspaceName"
                    }
                  },
                  "workspaceRegion": {
                    "type": "String",
                    "metadata": {
                      "description": "Select region of existing Log Analytics workspace",
                      "displayName": "workspaceRegion"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.OperationalInsights/workspaces",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "workspaceName": {
                              "value": "[parameters('workspaceName')]"
                            },
                            "workspaceRegion": {
                              "value": "[parameters('workspaceRegion')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "workspaceName": {
                                "type": "string"
                              },
                              "workspaceRegion": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2015-11-01-preview",
                                "kind": "LinuxPerformanceCollection",
                                "name": "[concat(parameters('workspaceName'), '/LinuxPerfCollection')]",
                                "properties": {
                                  "state": "Enabled"
                                },
                                "type": "Microsoft.OperationalInsights/workspaces/datasources"
                              },
                              {
                                "apiVersion": "2015-11-01-preview",
                                "kind": "LinuxPerformanceObject",
                                "name": "[concat(parameters('workspaceName'), '/', variables('vmInsightsPerfCounters').linuxDiskObject.armResourceName)]",
                                "properties": {
                                  "instanceName": "[variables('vmInsightsPerfCounters').linuxDiskObject.instanceName]",
                                  "intervalSeconds": "[variables('vmInsightsPerfCounters').linuxDiskObject.intervalSeconds]",
                                  "objectName": "[variables('vmInsightsPerfCounters').linuxDiskObject.objectName]",
                                  "performanceCounters": "[variables('vmInsightsPerfCounters').linuxDiskArray]"
                                },
                                "type": "Microsoft.OperationalInsights/workspaces/dataSources"
                              },
                              {
                                "apiVersion": "2015-11-01-preview",
                                "kind": "LinuxPerformanceObject",
                                "name": "[concat(parameters('workspaceName'), '/', variables('vmInsightsPerfCounters').linuxMemoryObject.armResourceName)]",
                                "properties": {
                                  "instanceName": "[variables('vmInsightsPerfCounters').linuxMemoryObject.instanceName]",
                                  "intervalSeconds": "[variables('vmInsightsPerfCounters').linuxMemoryObject.intervalSeconds]",
                                  "objectName": "[variables('vmInsightsPerfCounters').linuxMemoryObject.objectName]",
                                  "performanceCounters": "[variables('vmInsightsPerfCounters').linuxMemoryArray]"
                                },
                                "type": "Microsoft.OperationalInsights/workspaces/dataSources"
                              },
                              {
                                "apiVersion": "2015-11-01-preview",
                                "kind": "LinuxPerformanceObject",
                                "name": "[concat(parameters('workspaceName'), '/', variables('vmInsightsPerfCounters').linuxCpuObject.armResourceName)]",
                                "properties": {
                                  "instanceName": "[variables('vmInsightsPerfCounters').linuxCpuObject.instanceName]",
                                  "intervalSeconds": "[variables('vmInsightsPerfCounters').linuxCpuObject.intervalSeconds]",
                                  "objectName": "[variables('vmInsightsPerfCounters').linuxCpuObject.objectName]",
                                  "performanceCounters": "[variables('vmInsightsPerfCounters').linuxCpuArray]"
                                },
                                "type": "Microsoft.OperationalInsights/workspaces/dataSources"
                              },
                              {
                                "apiVersion": "2015-11-01-preview",
                                "kind": "LinuxPerformanceObject",
                                "name": "[concat(parameters('workspaceName'), '/', variables('vmInsightsPerfCounters').linuxNetworkObject.armResourceName)]",
                                "properties": {
                                  "instanceName": "[variables('vmInsightsPerfCounters').linuxNetworkObject.instanceName]",
                                  "intervalSeconds": "[variables('vmInsightsPerfCounters').linuxNetworkObject.intervalSeconds]",
                                  "objectName": "[variables('vmInsightsPerfCounters').linuxNetworkObject.objectName]",
                                  "performanceCounters": "[variables('vmInsightsPerfCounters').linuxNetworkArray]"
                                },
                                "type": "Microsoft.OperationalInsights/workspaces/dataSources"
                              },
                              {
                                "apiVersion": "2015-11-01-preview",
                                "copy": {
                                  "count": "[length(variables('vmInsightsPerfCounters').windowsArray)]",
                                  "name": "counterCopy"
                                },
                                "kind": "WindowsPerformanceCounter",
                                "name": "[concat(parameters('workspaceName'), '/', variables('vmInsightsPerfCounters').windowsArray[copyIndex()].armName)]",
                                "properties": {
                                  "counterName": "[variables('vmInsightsPerfCounters').windowsArray[copyIndex()].counterName]",
                                  "instanceName": "[variables('vmInsightsPerfCounters').windowsArray[copyIndex()].instanceName]",
                                  "intervalSeconds": "[variables('vmInsightsPerfCounters').windowsArray[copyIndex()].intervalSeconds]",
                                  "objectName": "[variables('vmInsightsPerfCounters').windowsArray[copyIndex()].objectName]"
                                },
                                "type": "Microsoft.OperationalInsights/workspaces/dataSources"
                              },
                              {
                                "apiVersion": "2015-11-01-preview",
                                "copy": {
                                  "count": "[length(variables('batch1').solutions)]",
                                  "name": "solutionCopy"
                                },
                                "location": "[parameters('workspaceRegion')]",
                                "name": "[concat(variables('batch1').solutions[copyIndex()].Name)]",
                                "plan": {
                                  "name": "[variables('batch1').solutions[copyIndex()].name]",
                                  "product": "[concat('OMSGallery/', variables('batch1').solutions[copyIndex()].marketplaceName)]",
                                  "promotionCode": "",
                                  "publisher": "Microsoft"
                                },
                                "properties": {
                                  "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
                                },
                                "type": "Microsoft.OperationsManagement/solutions"
                              }
                            ],
                            "variables": {
                              "batch1": {
                                "solutions": [
                                  {
                                    "marketplaceName": "Security",
                                    "name": "[concat('Security', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "AgentHealthAssessment",
                                    "name": "[concat('AgentHealthAssessment', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "ChangeTracking",
                                    "name": "[concat('ChangeTracking', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "Updates",
                                    "name": "[concat('Updates', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "AzureActivity",
                                    "name": "[concat('AzureActivity', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "AzureAutomation",
                                    "name": "[concat('AzureAutomation', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "ADAssessment",
                                    "name": "[concat('ADAssessment', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "SQLAssessment",
                                    "name": "[concat('SQLAssessment', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "VMInsights",
                                    "name": "[concat('VMInsights', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "ServiceMap",
                                    "name": "[concat('ServiceMap', '(', parameters('workspaceName'), ')')]"
                                  },
                                  {
                                    "marketplaceName": "SecurityInsights",
                                    "name": "[concat('SecurityInsights', '(', parameters('workspaceName'), ')')]"
                                  }
                                ]
                              },
                              "vmInsightsPerfCounters": {
                                "linuxCpuArray": [
                                  {
                                    "counterName": "% Processor Time"
                                  }
                                ],
                                "linuxCpuObject": {
                                  "armResourceName": "Processor",
                                  "instanceName": "*",
                                  "intervalSeconds": 10,
                                  "objectName": "Processor"
                                },
                                "linuxDiskArray": [
                                  {
                                    "counterName": "% Used Inodes"
                                  },
                                  {
                                    "counterName": "Free Megabytes"
                                  },
                                  {
                                    "counterName": "% Used Space"
                                  },
                                  {
                                    "counterName": "Disk Transfers/sec"
                                  },
                                  {
                                    "counterName": "Disk Reads/sec"
                                  },
                                  {
                                    "counterName": "Disk writes/sec"
                                  }
                                ],
                                "linuxDiskObject": {
                                  "armResourceName": "Disk",
                                  "instanceName": "*",
                                  "intervalSeconds": 10,
                                  "objectName": "Logical Disk"
                                },
                                "linuxMemoryArray": [
                                  {
                                    "counterName": "Available MBytes Memory"
                                  }
                                ],
                                "linuxMemoryObject": {
                                  "armResourceName": "Memory",
                                  "instanceName": "*",
                                  "intervalSeconds": 10,
                                  "objectName": "Memory"
                                },
                                "linuxNetworkArray": [
                                  {
                                    "counterName": "Total Bytes Received"
                                  },
                                  {
                                    "counterName": "Total Bytes Transmitted"
                                  }
                                ],
                                "linuxNetworkObject": {
                                  "armResourceName": "Network",
                                  "instanceName": "*",
                                  "intervalSeconds": 10,
                                  "objectName": "Network"
                                },
                                "windowsArray": [
                                  {
                                    "armName": "counter1",
                                    "counterName": "% Free Space",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter2",
                                    "counterName": "Avg. Disk sec/Read",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter3",
                                    "counterName": "Avg. Disk sec/Transfer",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter4",
                                    "counterName": "Avg. Disk sec/Write",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter5",
                                    "counterName": "Disk Read Bytes/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter6",
                                    "counterName": "Disk Reads/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter7",
                                    "counterName": "Disk Transfers/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter8",
                                    "counterName": "Disk Write Bytes/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter9",
                                    "counterName": "Disk Writes/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter10",
                                    "counterName": "Free Megabytes",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "LogicalDisk"
                                  },
                                  {
                                    "armName": "counter11",
                                    "counterName": "Available MBytes",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "Memory"
                                  },
                                  {
                                    "armName": "counter12",
                                    "counterName": "Bytes Received/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "Network Adapter"
                                  },
                                  {
                                    "armName": "counter13",
                                    "counterName": "Bytes Sent/sec",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "Network Adapter"
                                  },
                                  {
                                    "armName": "counter14",
                                    "counterName": "% Processor Time",
                                    "instanceName": "*",
                                    "intervalSeconds": 10,
                                    "objectName": "Processor"
                                  }
                                ]
                              }
                            }
                          }
                        }
                      },
                      "deploymentScope": "resourceGroup",
                      "existenceCondition": {
                        "allOf": [
                          {
                            "field": "name",
                            "like": "[parameters('workspaceName')]"
                          },
                          {
                            "equals": "[parameters('workspaceRegion')]",
                            "field": "location"
                          }
                        ]
                      },
                      "existenceScope": "Subscription",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
                      ],
                      "type": "Microsoft.OperationalInsights/workspaces"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Log-Analytics",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Log-Analytics",
              "ResourceName": "Deploy-Log-Analytics",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Log-Analytics",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-LogAnalytics",
                "Mode": "All",
                "Parameters": {
                  "automationAccountName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for automation account",
                      "displayName": "automationAccountName"
                    }
                  },
                  "automationRegion": {
                    "type": "String",
                    "metadata": {
                      "description": "Select Azure region for Automation account",
                      "displayName": "automationRegion"
                    }
                  },
                  "rgName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for resource group.",
                      "displayName": "rgName"
                    }
                  },
                  "workspaceName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for log analytics workspace",
                      "displayName": "workspaceName"
                    }
                  },
                  "workspaceRegion": {
                    "type": "String",
                    "metadata": {
                      "description": "Select Azure region for Log Analytics",
                      "displayName": "workspaceRegion"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "automationAccountName": {
                              "value": "[parameters('automationAccountName')]"
                            },
                            "automationRegion": {
                              "value": "[parameters('automationRegion')]"
                            },
                            "rgName": {
                              "value": "[parameters('rgName')]"
                            },
                            "workspaceName": {
                              "value": "[parameters('workspaceName')]"
                            },
                            "workspaceRegion": {
                              "value": "[parameters('workspaceRegion')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "automationAccountName": {
                                "type": "string"
                              },
                              "automationRegion": {
                                "type": "string"
                              },
                              "rgName": {
                                "type": "string"
                              },
                              "workspaceName": {
                                "type": "string"
                              },
                              "workspaceRegion": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-05-01",
                                "location": "[deployment().location]",
                                "name": "[parameters('rgName')]",
                                "properties": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                                ],
                                "name": "log-analytics",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                                    "contentVersion": "1.0.0.0",
                                    "outputs": {},
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiversion": "2015-10-31",
                                        "comments": "Automation account for ",
                                        "location": "[parameters('AutomationRegion')]",
                                        "name": "[parameters('AutomationAccountName')]",
                                        "properties": {
                                          "sku": {
                                            "name": "OMS"
                                          }
                                        },
                                        "type": "Microsoft.Automation/automationAccounts"
                                      },
                                      {
                                        "apiVersion": "2017-03-15-preview",
                                        "location": "[parameters('workspaceRegion')]",
                                        "name": "[parameters('workspaceName')]",
                                        "properties": {
                                          "enableLogAccessUsingOnlyResourcePermissions": true,
                                          "sku": {
                                            "name": "pernode"
                                          }
                                        },
                                        "resources": [
                                          {
                                            "apiVersion": "2015-11-01-preview",
                                            "dependsOn": [
                                              "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",
                                              "[resourceId('Microsoft.Automation/automationAccounts/', parameters('AutomationAccountName'))]"
                                            ],
                                            "name": "Automation",
                                            "properties": {
                                              "resourceId": "[concat(subscription().id, '/resourceGroups/', parameters('rgName'), '/providers/Microsoft.Automation/automationAccounts/', parameters('AutomationAccountName'))]"
                                            },
                                            "type": "linkedServices"
                                          }
                                        ],
                                        "type": "Microsoft.OperationalInsights/workspaces"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceCondition": {
                        "allOf": [
                          {
                            "field": "name",
                            "like": "[parameters('workspaceName')]"
                          }
                        ]
                      },
                      "existenceScope": "Subscription",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.OperationalInsights/workspaces"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Nsg-FlowLogs",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Nsg-FlowLogs",
              "ResourceName": "Deploy-Nsg-FlowLogs",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Nsg-FlowLogs",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-Nsg-FlowLogs",
                "Mode": "All",
                "Parameters": {
                  "retention": {
                    "type": "Integer",
                    "metadata": {
                      "displayName": "Retention"
                    }
                  },
                  "storageAccountResourceId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Storage Account Resource Id"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Network/networkSecurityGroups",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "networkSecurityGroupName": {
                              "value": "[field('name')]"
                            },
                            "resourceGroupName": {
                              "value": "[resourceGroup().name]"
                            },
                            "retention": {
                              "value": "[parameters('retention')]"
                            },
                            "storageAccountResourceId": {
                              "value": "[parameters('storageAccountResourceId')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "networkSecurityGroupName": {
                                "type": "string"
                              },
                              "resourceGroupName": {
                                "type": "string"
                              },
                              "retention": {
                                "defaultValue": 5,
                                "type": "int"
                              },
                              "storageAccountResourceId": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2019-11-01",
                                "location": "[parameters('location')]",
                                "name": "[concat('NetworkWatcher_', toLower(parameters('location')), '/', 'flowLogs')]",
                                "properties": {
                                  "enabled": true,
                                  "format": {
                                    "type": "JSON",
                                    "version": 2
                                  },
                                  "retentionPolicy": {
                                    "days": "[parameters('retention')]",
                                    "enabled": true
                                  },
                                  "storageId": "[parameters('storageAccountResourceId')]",
                                  "targetResourceId": "[resourceId(parameters('resourceGroupName'), 'Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                                },
                                "type": "Microsoft.Network/networkWatchers/flowLogs"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "equals": "true",
                        "field": "Microsoft.Network/networkWatchers/flowLogs/enabled"
                      },
                      "name": "[concat('NetworkWatcher_', field('location'), '/', 'Microsoft.Network', resourceGroup().name, field('name'))]",
                      "resourceGroupName": "NetworkWatcherRG",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/networkWatchers/flowLogs"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Sql-AuditingSettings",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-AuditingSettings",
              "ResourceName": "Deploy-Sql-AuditingSettings",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-AuditingSettings",
              "Properties": {
                "Description": "Configures SQL Server",
                "DisplayName": "Deploy-Sql-AuditingSettings",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/servers/databases",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "sqlServerDataBaseName": {
                              "value": "[field('name')]"
                            },
                            "sqlServerName": {
                              "value": "[first(split(field('fullname'),'/'))]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "sqlServerDataBaseName": {
                                "type": "string"
                              },
                              "sqlServerName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-03-01-preview",
                                "name": "[concat( parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                                "properties": {
                                  "auditActionsAndGroups": [
                                    "BATCH_COMPLETED_GROUP",
                                    "DATABASE_OBJECT_CHANGE_GROUP",
                                    "SCHEMA_OBJECT_CHANGE_GROUP",
                                    "BACKUP_RESTORE_GROUP",
                                    "APPLICATION_ROLE_CHANGE_PASSWORD_GROUP",
                                    "DATABASE_PRINCIPAL_CHANGE_GROUP",
                                    "DATABASE_PRINCIPAL_IMPERSONATION_GROUP",
                                    "DATABASE_ROLE_MEMBER_CHANGE_GROUP",
                                    "USER_CHANGE_PASSWORD_GROUP",
                                    "DATABASE_OBJECT_OWNERSHIP_CHANGE_GROUP",
                                    "DATABASE_OBJECT_PERMISSION_CHANGE_GROUP",
                                    "DATABASE_PERMISSION_CHANGE_GROUP",
                                    "SCHEMA_OBJECT_PERMISSION_CHANGE_GROUP",
                                    "SUCCESSFUL_DATABASE_AUTHENTICATION_GROUP",
                                    "FAILED_DATABASE_AUTHENTICATION_GROUP"
                                  ],
                                  "isAzureMonitorTargetEnabled": true,
                                  "state": "enabled"
                                },
                                "type": "Microsoft.Sql/servers/databases/auditingSettings"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "enabled",
                            "field": "Microsoft.Sql/servers/databases/auditingSettings/state"
                          },
                          {
                            "equals": "true",
                            "field": "Microsoft.Sql/servers/databases/auditingSettings/isAzureMonitorTargetEnabled"
                          }
                        ]
                      },
                      "name": "default",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Sql/servers/databases/auditingSettings"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Sql-SecurityAlertPolicies",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-SecurityAlertPolicies",
              "ResourceName": "Deploy-Sql-SecurityAlertPolicies",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-SecurityAlertPolicies",
              "Properties": {
                "Description": "Configures SQL DataBases",
                "DisplayName": "Deploy-Sql-SecurityAlertPolicies",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/servers/databases",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "sqlServerDataBaseName": {
                              "value": "[field('name')]"
                            },
                            "sqlServerName": {
                              "value": "[first(split(field('fullname'),'/'))]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "sqlServerDataBaseName": {
                                "type": "string"
                              },
                              "sqlServerName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-06-01-preview",
                                "name": "[concat(parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                                "properties": {
                                  "disabledAlerts": [
                                    ""
                                  ],
                                  "emailAccountAdmins": true,
                                  "emailAddresses": [
                                    "admin@contoso.com"
                                  ],
                                  "retentionDays": 0,
                                  "state": "Enabled",
                                  "storageAccountAccessKey": ""
                                },
                                "type": "Microsoft.Sql/servers/databases/securityAlertPolicies"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "Enabled",
                            "field": "Microsoft.Sql/servers/databases/securityAlertPolicies/state"
                          }
                        ]
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Sql/servers/databases/securityAlertPolicies"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Sql-Tde",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-Tde",
              "ResourceName": "Deploy-Sql-Tde",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-Tde",
              "Properties": {
                "Description": "Configures SQL DataBases",
                "DisplayName": "Deploy-Sql-Tde",
                "Mode": "All",
                "Parameters": null,
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/servers/databases",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "sqlServerDataBaseName": {
                              "value": "[field('name')]"
                            },
                            "sqlServerName": {
                              "value": "[first(split(field('fullname'),'/'))]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "sqlServerDataBaseName": {
                                "type": "string"
                              },
                              "sqlServerName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2014-04-01",
                                "name": "[concat( parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/current')]",
                                "properties": {
                                  "status": "Enabled"
                                },
                                "type": "Microsoft.Sql/servers/databases/transparentDataEncryption"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "Enabled",
                            "field": "Microsoft.Sql/transparentDataEncryption.status"
                          }
                        ]
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Sql/servers/databases/transparentDataEncryption"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Sql-vulnerabilityAssessments",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-vulnerabilityAssessments",
              "ResourceName": "Deploy-Sql-vulnerabilityAssessments",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-vulnerabilityAssessments",
              "Properties": {
                "Description": "Configures SQL DataBases",
                "DisplayName": "Deploy-Sql-vulnerabilityAssessments",
                "Mode": "All",
                "Parameters": {
                  "vulnerabilityAssessmentsEmail": {
                    "type": "String",
                    "metadata": {
                      "description": "The email address to send alerts",
                      "displayName": "The email address to send alerts"
                    }
                  },
                  "vulnerabilityAssessmentsStorageID": {
                    "type": "String",
                    "metadata": {
                      "description": "The storage account to store assessments",
                      "displayName": "The storage account to store assessments"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "equals": "Microsoft.Sql/servers/databases",
                    "field": "type"
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "location": {
                              "value": "[field('location')]"
                            },
                            "sqlServerDataBaseName": {
                              "value": "[field('name')]"
                            },
                            "sqlServerName": {
                              "value": "[first(split(field('fullname'),'/'))]"
                            },
                            "vulnerabilityAssessmentsEmail": {
                              "value": "[parameters('vulnerabilityAssessmentsEmail')]"
                            },
                            "vulnerabilityAssessmentsStorageID": {
                              "value": "[parameters('vulnerabilityAssessmentsStorageID')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "sqlServerDataBaseName": {
                                "type": "string"
                              },
                              "sqlServerName": {
                                "type": "string"
                              },
                              "vulnerabilityAssessmentsEmail": {
                                "type": "string"
                              },
                              "vulnerabilityAssessmentsStorageID": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2017-03-01-preview",
                                "name": "[concat(parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                                "properties": {
                                  "recurringScans": {
                                    "emailSubscriptionAdmins": false,
                                    "emails": [
                                      "[parameters('vulnerabilityAssessmentsEmail')]"
                                    ],
                                    "isEnabled": true
                                  },
                                  "storageAccountAccessKey": "[listkeys(parameters('vulnerabilityAssessmentsStorageID'), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]",
                                  "storageContainerPath": "[concat('https://', last( split(parameters('vulnerabilityAssessmentsStorageID') , '/') ) , '.blob.core.windows.net/vulneraabilitylogs')]"
                                },
                                "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments"
                              }
                            ],
                            "variables": {}
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "[parameters('vulnerabilityAssessmentsEmail')]",
                            "field": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.emails"
                          },
                          {
                            "equals": true,
                            "field": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.isEnabled"
                          }
                        ]
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-vHUB",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-vHUB",
              "ResourceName": "Deploy-vHUB",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-vHUB",
              "Properties": {
                "Description": "Deploys Azure Virtual WAN vHUB in desired regions",
                "DisplayName": "Deploy-vHUB",
                "Mode": "All",
                "Parameters": {
                  "azfw": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing the Azure Firewall in vHUB",
                      "displayName": "azfw"
                    },
                    "defaultValue": {}
                  },
                  "ergw": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing ExpressRoute gateway",
                      "displayName": "ergw"
                    },
                    "defaultValue": {}
                  },
                  "rgName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for resource group.",
                      "displayName": "rgName"
                    }
                  },
                  "vHUB": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing Virtual WAN vHUB",
                      "displayName": "vHUB"
                    }
                  },
                  "vHubName": {
                    "type": "String",
                    "metadata": {
                      "description": "Name of the vHUB",
                      "displayName": "vHubName"
                    },
                    "defaultValue": ""
                  },
                  "vpngw": {
                    "type": "Object",
                    "metadata": {
                      "description": "Object describing VPN gateway",
                      "displayName": "vpngw"
                    },
                    "defaultValue": {}
                  },
                  "vwanname": {
                    "type": "String",
                    "metadata": {
                      "description": "Name of the Virtual WAN",
                      "displayName": "vwanname"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "ResourceGroupName": "[parameters('rgName')]",
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "azfw": {
                              "value": "[parameters('azfw')]"
                            },
                            "ergw": {
                              "value": "[parameters('ergw')]"
                            },
                            "rgName": {
                              "value": "[parameters('rgName')]"
                            },
                            "vHUB": {
                              "value": "[parameters('vHUB')]"
                            },
                            "vHUBName": {
                              "value": "[parameters('vHUBName')]"
                            },
                            "vpngw": {
                              "value": "[parameters('vpngw')]"
                            },
                            "vwanname": {
                              "value": "[parameters('vwanname')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "azfw": {
                                "defaultValue": {},
                                "metadata": {
                                  "description": "Object describing the Azure Firewall in vHUB"
                                },
                                "type": "object"
                              },
                              "ergw": {
                                "defaultValue": {},
                                "metadata": {
                                  "description": "Object describing ExpressRoute gateway"
                                },
                                "type": "object"
                              },
                              "rgName": {
                                "metadata": {
                                  "description": "Provide name for resource group.",
                                  "displayName": "rgName"
                                },
                                "type": "String"
                              },
                              "vHUB": {
                                "metadata": {
                                  "description": "Object describing Virtual WAN vHUB"
                                },
                                "type": "object"
                              },
                              "vHUBName": {
                                "metadata": {
                                  "description": "Name of the vHUB",
                                  "displayName": "vHUBName"
                                },
                                "type": "String"
                              },
                              "vpngw": {
                                "defaultValue": {},
                                "metadata": {
                                  "description": "Object describing VPN gateway"
                                },
                                "type": "object"
                              },
                              "vwanname": {
                                "metadata": {
                                  "description": "Name of the Virtual WAN"
                                },
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-05-01",
                                "location": "[deployment().location]",
                                "name": "[parameters('rgName')]",
                                "properties": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                                ],
                                "name": "[concat('vHUBdeploy-',parameters('vHUB').location)]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('vHUB').location]",
                                        "name": "[parameters('vHUBname')]",
                                        "properties": {
                                          "addressPrefix": "[parameters('vHUB').addressPrefix]",
                                          "sku": "[variables('vhubsku')]",
                                          "virtualWan": {
                                            "id": "[variables('vwanresourceid')]"
                                          }
                                        },
                                        "type": "Microsoft.Network/virtualHubs"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "condition": "[greater(length(parameters('vpngw')),0)]",
                                "dependsOn": [
                                  "[concat('vHUBdeploy-',parameters('vHUB').location)]"
                                ],
                                "name": "[concat(parameters('vHUBName'),'-vpngw')]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('vHUB').location]",
                                        "name": "[parameters('vpngw').name]",
                                        "properties": {
                                          "bgpSettings": "[parameters('vpngw').bgpSettings]",
                                          "virtualHub": {
                                            "id": "[variables('vwanhub')]"
                                          },
                                          "vpnGatewayScaleUnit": "[parameters('vpngw').vpnGatewayScaleUnit]"
                                        },
                                        "type": "Microsoft.Network/vpnGateways"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "condition": "[greater(length(parameters('ergw')),0)]",
                                "dependsOn": [
                                  "[concat('vHUBdeploy-',parameters('vHUB').location)]"
                                ],
                                "name": "[concat(parameters('vHUBName'),'-ergw')]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('vHUB').location]",
                                        "name": "[parameters('ergw').name]",
                                        "properties": {
                                          "autoScaleConfiguration": "[parameters('ergw').autoScaleConfiguration]",
                                          "virtualHub": {
                                            "id": "[variables('vwanhub')]"
                                          }
                                        },
                                        "type": "Microsoft.Network/expressRouteGateways"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ],
                            "variables": {
                              "vhubsku": "Standard",
                              "vwanhub": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'),'/providers/Microsoft.Network/virtualHubs/',parameters('vHUBName'))]",
                              "vwanresourceid": "[concat(subscription().id,'/resourceGroups/',parameters('rgName'),'/providers/Microsoft.Network/virtualWans/',parameters('vwanname'))]"
                            }
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceScope": "ResourceGroup",
                      "name": "[parameters('vHubName')]",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/virtualHubs"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-vNet",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-vNet",
              "ResourceName": "Deploy-vNet",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-vNet",
              "Properties": {
                "Description": "Deploy-vNet",
                "DisplayName": "Deploy-vNet",
                "Mode": "All",
                "Parameters": {
                  "ipam": {
                    "type": "Array",
                    "metadata": {
                      "displayName": "ipam"
                    },
                    "defaultValue": []
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "ipam": {
                              "defaultValue": [],
                              "value": "[parameters('ipam')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "outputs": {
                              "ipam": {
                                "condition": "[bool('true')]",
                                "type": "Int",
                                "value": "[length(parameters('ipam'))]"
                              }
                            },
                            "parameters": {
                              "ipam": {
                                "defaultValue": [
                                  {
                                    "hubVirtualNetworkConnection": {
                                      "properties": {
                                        "allowHubToRemoteVnetTransit": true,
                                        "allowRemoteVnetToUseHubVnetGateways": false,
                                        "enableInternetSecurity": true
                                      },
                                      "vWanVhubResourceId": "/subscriptions/99c2838f-a548-4884-a6e2-38c1f8fb4c0b/resourceGroups/contoso-global-vwan/providers/Microsoft.Network/virtualHubs/contoso-vhub-weu"
                                    },
                                    "location": "westeurope",
                                    "name": "bu1-weu-msx3-vNet1",
                                    "networkSecurityGroups": {
                                      "properties": {
                                        "securityRules": []
                                      }
                                    },
                                    "routeTables": {
                                      "properties": {
                                        "routes": []
                                      }
                                    },
                                    "virtualNetworks": {
                                      "properties": {
                                        "addressSpace": {
                                          "addressPrefixes": [
                                            "10.51.217.0/24"
                                          ]
                                        }
                                      }
                                    }
                                  }
                                ],
                                "type": "Array"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2020-06-01",
                                "condition": "[if(and(not(empty(parameters('ipam'))), equals(toLower(parameters('ipam')[copyIndex()].name),toLower(variables('vNetName')))),bool('true'),bool('false'))]",
                                "copy": {
                                  "count": "[length(parameters('ipam'))]",
                                  "name": "ipam-rg-loop"
                                },
                                "dependsOn": [],
                                "location": "[parameters('ipam')[copyIndex()].location]",
                                "name": "[concat('es-ipam-',subscription().displayName,'-RG-',copyIndex())]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "outputs": {},
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-06-01",
                                        "location": "[parameters('ipam')[copyIndex()].location]",
                                        "name": "[variables('vNetRgName')]",
                                        "properties": {},
                                        "type": "Microsoft.Resources/resourceGroups"
                                      },
                                      {
                                        "apiVersion": "2020-06-01",
                                        "location": "[parameters('ipam')[copyIndex()].location]",
                                        "name": "NetworkWatcherRG",
                                        "properties": {},
                                        "type": "Microsoft.Resources/resourceGroups"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "type": "Microsoft.Resources/deployments"
                              },
                              {
                                "apiVersion": "2020-06-01",
                                "condition": "[if(and(not(empty(parameters('ipam'))), equals(toLower(parameters('ipam')[copyIndex()].name),toLower(variables('vNetName')))),bool('true'),bool('false'))]",
                                "copy": {
                                  "count": "[length(parameters('ipam'))]",
                                  "name": "ipam-loop"
                                },
                                "dependsOn": [
                                  "[concat('es-ipam-',subscription().displayName,'-RG-',copyIndex())]"
                                ],
                                "name": "[concat('es-ipam-',subscription().displayName,'-nsg-udr-vnet-hub-vwan-peering-',copyIndex())]",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "outputs": {},
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "condition": "[contains(parameters('ipam')[copyIndex()],'networkSecurityGroups')]",
                                        "location": "[parameters('ipam')[copyIndex()].location]",
                                        "name": "[concat(subscription().displayName, '-nsg')]",
                                        "properties": "[if(contains(parameters('ipam')[copyIndex()],'networkSecurityGroups'),parameters('ipam')[copyIndex()].networkSecurityGroups.properties,json('null'))]",
                                        "type": "Microsoft.Network/networkSecurityGroups"
                                      },
                                      {
                                        "apiVersion": "2020-05-01",
                                        "condition": "[contains(parameters('ipam')[copyIndex()],'routeTables')]",
                                        "location": "[parameters('ipam')[copyIndex()].location]",
                                        "name": "[concat(subscription().displayName, '-udr')]",
                                        "properties": "[if(contains(parameters('ipam')[copyIndex()],'routeTables'),parameters('ipam')[copyIndex()].routeTables.properties,json('null'))]",
                                        "type": "Microsoft.Network/routeTables"
                                      },
                                      {
                                        "apiVersion": "2020-05-01",
                                        "condition": "[contains(parameters('ipam')[copyIndex()],'virtualNetworks')]",
                                        "dependsOn": [
                                          "[concat(subscription().displayName, '-nsg')]",
                                          "[concat(subscription().displayName, '-udr')]"
                                        ],
                                        "location": "[parameters('ipam')[copyIndex()].location]",
                                        "name": "[concat(subscription().displayName, '-vnet')]",
                                        "properties": "[if(contains(parameters('ipam')[copyIndex()],'virtualNetworks'),parameters('ipam')[copyIndex()].virtualNetworks.properties,json('null'))]",
                                        "type": "Microsoft.Network/virtualNetworks"
                                      },
                                      {
                                        "apiVersion": "2020-05-01",
                                        "condition": "[contains(parameters('ipam')[copyIndex()],'virtualNetworkPeerings')]",
                                        "dependsOn": [
                                          "[concat(subscription().displayName, '-vnet')]"
                                        ],
                                        "name": "[concat(variables('vNetName'), '/peerToHub')]",
                                        "properties": "[if(contains(parameters('ipam')[copyIndex()],'virtualNetworkPeerings'),parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties,json('null'))]",
                                        "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings"
                                      },
                                      {
                                        "apiVersion": "2020-06-01",
                                        "condition": "[and(contains(parameters('ipam')[copyIndex()],'virtualNetworks'),contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId'))]",
                                        "dependsOn": [
                                          "[concat(subscription().displayName, '-vnet')]"
                                        ],
                                        "name": "[concat('es-ipam-vWan-',subscription().displayName,'-peering-',copyIndex())]",
                                        "properties": {
                                          "expressionEvaluationOptions": {
                                            "scope": "inner"
                                          },
                                          "mode": "Incremental",
                                          "parameters": {
                                            "allowHubToRemoteVnetTransit": {
                                              "value": "[if(and(contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId')),parameters('ipam')[copyIndex()].hubVirtualNetworkConnection.properties.allowHubToRemoteVnetTransit,json('null'))]"
                                            },
                                            "allowRemoteVnetToUseHubVnetGateways": {
                                              "value": "[if(and(contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId')),parameters('ipam')[copyIndex()].hubVirtualNetworkConnection.properties.allowRemoteVnetToUseHubVnetGateways,json('null'))]"
                                            },
                                            "enableInternetSecurity": {
                                              "value": "[if(and(contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId')),parameters('ipam')[copyIndex()].hubVirtualNetworkConnection.properties.enableInternetSecurity,json('null'))]"
                                            },
                                            "remoteVirtualNetwork": {
                                              "value": "[concat(subscription().id,'/resourceGroups/',variables('vNetRgName'), '/providers/','Microsoft.Network/virtualNetworks/', concat(subscription().displayName, '-vnet'))]"
                                            },
                                            "vWanVhubName": {
                                              "value": "[if(and(contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId')),split(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection.vWanVhubResourceId,'/')[8],json('null'))]"
                                            }
                                          },
                                          "template": {
                                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                            "contentVersion": "1.0.0.0",
                                            "outputs": {},
                                            "parameters": {
                                              "allowHubToRemoteVnetTransit": {
                                                "Type": "bool",
                                                "defaultValue": true
                                              },
                                              "allowRemoteVnetToUseHubVnetGateways": {
                                                "Type": "bool",
                                                "defaultValue": false
                                              },
                                              "enableInternetSecurity": {
                                                "Type": "bool",
                                                "defaultValue": true
                                              },
                                              "remoteVirtualNetwork": {
                                                "type": "string"
                                              },
                                              "vWanVhubName": {
                                                "Type": "string",
                                                "defaultValue": ""
                                              }
                                            },
                                            "resources": [
                                              {
                                                "apiVersion": "2020-05-01",
                                                "name": "[[concat(parameters('vWanVhubName'),'/',last(split(parameters('remoteVirtualNetwork'),'/')))]",
                                                "properties": {
                                                  "allowHubToRemoteVnetTransit": "[[parameters('allowHubToRemoteVnetTransit')]",
                                                  "allowRemoteVnetToUseHubVnetGateways": "[[parameters('allowRemoteVnetToUseHubVnetGateways')]",
                                                  "enableInternetSecurity": "[[parameters('enableInternetSecurity')]",
                                                  "remoteVirtualNetwork": {
                                                    "id": "[[parameters('remoteVirtualNetwork')]"
                                                  }
                                                },
                                                "type": "Microsoft.Network/virtualHubs/hubVirtualNetworkConnections"
                                              }
                                            ],
                                            "variables": {}
                                          }
                                        },
                                        "resourceGroup": "[if(and(contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId')),split(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection.vWanVhubResourceId,'/')[4],json('null'))]",
                                        "subscriptionId": "[if(and(contains(parameters('ipam')[copyIndex()],'hubVirtualNetworkConnection'),contains(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection,'vWanVhubResourceId')),split(parameters('ipam')[copyIndex()].hubVirtualNetworkConnection.vWanVhubResourceId,'/')[2],json('null'))]",
                                        "type": "Microsoft.Resources/deployments"
                                      },
                                      {
                                        "apiVersion": "2020-06-01",
                                        "condition": "[and(contains(parameters('ipam')[copyIndex()],'virtualNetworks'),contains(parameters('ipam')[copyIndex()],'virtualNetworkPeerings'),contains(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork,'id'))]",
                                        "dependsOn": [
                                          "[concat(subscription().displayName, '-vnet')]"
                                        ],
                                        "name": "[concat('es-ipam-hub-',subscription().displayName,'-peering-',copyIndex())]",
                                        "properties": {
                                          "expressionEvaluationOptions": {
                                            "scope": "inner"
                                          },
                                          "mode": "Incremental",
                                          "parameters": {
                                            "hubName": {
                                              "value": "[if(and(contains(parameters('ipam')[copyIndex()],'virtualNetworkPeerings'),contains(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork,'id')),split(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork.id,'/')[8],json('null'))]"
                                            },
                                            "remoteVirtualNetwork": {
                                              "value": "[concat(subscription().id,'/resourceGroups/',variables('vNetRgName'), '/providers/','Microsoft.Network/virtualNetworks/', concat(subscription().displayName, '-vnet'))]"
                                            }
                                          },
                                          "template": {
                                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                            "contentVersion": "1.0.0.0",
                                            "outputs": {},
                                            "parameters": {
                                              "hubName": {
                                                "Type": "string",
                                                "defaultValue": false
                                              },
                                              "remoteVirtualNetwork": {
                                                "Type": "string",
                                                "defaultValue": false
                                              }
                                            },
                                            "resources": [
                                              {
                                                "apiVersion": "2020-05-01",
                                                "name": "[[concat(parameters('hubName'),'/',last(split(parameters('remoteVirtualNetwork'),'/')))]",
                                                "properties": {
                                                  "allowForwardedTraffic": true,
                                                  "allowGatewayTransit": true,
                                                  "allowVirtualNetworkAccess": true,
                                                  "remoteVirtualNetwork": {
                                                    "id": "[[parameters('remoteVirtualNetwork')]"
                                                  },
                                                  "useRemoteGateways": false
                                                },
                                                "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings"
                                              }
                                            ],
                                            "variables": {}
                                          }
                                        },
                                        "resourceGroup": "[if(and(contains(parameters('ipam')[copyIndex()],'virtualNetworkPeerings'),contains(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork,'id')),split(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork.id,'/')[4],json('null'))]",
                                        "subscriptionId": "[if(and(contains(parameters('ipam')[copyIndex()],'virtualNetworkPeerings'),contains(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork,'id')),split(parameters('ipam')[copyIndex()].virtualNetworkPeerings.properties.remoteVirtualNetwork.id,'/')[2],json('null'))]",
                                        "type": "Microsoft.Resources/deployments"
                                      }
                                    ],
                                    "variables": {}
                                  }
                                },
                                "resourceGroup": "[variables('vNetRgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ],
                            "variables": {
                              "vNetName": "[concat(subscription().displayName, '-vNet')]",
                              "vNetRgName": "[concat(subscription().displayName, '-network')]",
                              "vNetSubId": "[subscription().subscriptionId]"
                            }
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "Microsoft.Resources/subscriptions/resourceGroups",
                            "field": "type"
                          },
                          {
                            "field": "name",
                            "like": "[concat(subscription().displayName, '-network')]"
                          }
                        ]
                      },
                      "existenceScope": "Subscription",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
                      ],
                      "type": "Microsoft.Resources/resourceGroups"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-vWAN",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-vWAN",
              "ResourceName": "Deploy-vWAN",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-vWAN",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-vWAN",
                "Mode": "All",
                "Parameters": {
                  "rgName": {
                    "type": "String",
                    "metadata": {
                      "description": "Provide name for resource group.",
                      "displayName": "rgName"
                    }
                  },
                  "vwanRegion": {
                    "type": "String",
                    "metadata": {
                      "description": "Select Azure region for Virtual WAN",
                      "displayName": "vwanRegion",
                      "strongType": "location"
                    }
                  },
                  "vwanname": {
                    "type": "String",
                    "metadata": {
                      "description": "Name of the Virtual WAN",
                      "displayName": "vwanname"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Resources/subscriptions",
                        "field": "type"
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "location": "northeurope",
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "rgName": {
                              "value": "[parameters('rgName')]"
                            },
                            "vwanRegion": {
                              "value": "[parameters('vwanRegion')]"
                            },
                            "vwanname": {
                              "value": "[parameters('vwanname')]"
                            }
                          },
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "rgName": {
                                "type": "string"
                              },
                              "vwanRegion": {
                                "type": "string"
                              },
                              "vwanname": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2018-05-01",
                                "location": "[deployment().location]",
                                "name": "[parameters('rgName')]",
                                "properties": {},
                                "type": "Microsoft.Resources/resourceGroups"
                              },
                              {
                                "apiVersion": "2018-05-01",
                                "dependsOn": [
                                  "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                                ],
                                "name": "vwan",
                                "properties": {
                                  "mode": "Incremental",
                                  "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                                    "contentVersion": "1.0.0.0",
                                    "outputs": {},
                                    "parameters": {},
                                    "resources": [
                                      {
                                        "apiVersion": "2020-05-01",
                                        "location": "[parameters('vwanRegion')]",
                                        "name": "[parameters('vwanname')]",
                                        "properties": {
                                          "type": "[variables('vwansku')]",
                                          "virtualHubs": [],
                                          "vpnSites": []
                                        },
                                        "type": "Microsoft.Network/virtualWans"
                                      }
                                    ]
                                  }
                                },
                                "resourceGroup": "[parameters('rgName')]",
                                "type": "Microsoft.Resources/deployments"
                              }
                            ],
                            "variables": {
                              "vwansku": "Standard"
                            }
                          }
                        }
                      },
                      "deploymentScope": "Subscription",
                      "existenceScope": "ResourceGroup",
                      "name": "[parameters('vwanname')]",
                      "resourceGroupName": "[parameters('rgName')]",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Network/virtualWans"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            },
            {
              "Name": "Deploy-Windows-DomainJoin",
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Windows-DomainJoin",
              "ResourceName": "Deploy-Windows-DomainJoin",
              "ResourceType": "Microsoft.Authorization/policyDefinitions",
              "SubscriptionId": null,
              "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Windows-DomainJoin",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deploy-Windows-DomainJoin",
                "Mode": "All",
                "Parameters": {
                  "domainFQDN": {
                    "type": "String",
                    "metadata": {
                      "displayName": "domainFQDN"
                    }
                  },
                  "domainOUPath": {
                    "type": "String",
                    "metadata": {
                      "displayName": "domainOUPath"
                    }
                  },
                  "domainPassword": {
                    "type": "String",
                    "metadata": {
                      "displayName": "domainPassword"
                    }
                  },
                  "domainUsername": {
                    "type": "String",
                    "metadata": {
                      "displayName": "domainUsername"
                    }
                  },
                  "keyVaultResourceId": {
                    "type": "String",
                    "metadata": {
                      "displayName": "keyVaultResourceId"
                    }
                  }
                },
                "PolicyRule": {
                  "if": {
                    "allOf": [
                      {
                        "equals": "Microsoft.Compute/virtualMachines",
                        "field": "type"
                      },
                      {
                        "equals": "MicrosoftWindowsServer",
                        "field": "Microsoft.Compute/imagePublisher"
                      },
                      {
                        "equals": "WindowsServer",
                        "field": "Microsoft.Compute/imageOffer"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "2008-R2-SP1",
                          "2008-R2-SP1-smalldisk",
                          "2008-R2-SP1-zhcn",
                          "2012-Datacenter",
                          "2012-datacenter-gensecond",
                          "2012-Datacenter-smalldisk",
                          "2012-datacenter-smalldisk-g2",
                          "2012-Datacenter-zhcn",
                          "2012-datacenter-zhcn-g2",
                          "2012-R2-Datacenter",
                          "2012-r2-datacenter-gensecond",
                          "2012-R2-Datacenter-smalldisk",
                          "2012-r2-datacenter-smalldisk-g2",
                          "2012-R2-Datacenter-zhcn",
                          "2012-r2-datacenter-zhcn-g2",
                          "2016-Datacenter",
                          "2016-datacenter-gensecond",
                          "2016-datacenter-gs",
                          "2016-Datacenter-Server-Core",
                          "2016-datacenter-server-core-g2",
                          "2016-Datacenter-Server-Core-smalldisk",
                          "2016-datacenter-server-core-smalldisk-g2",
                          "2016-Datacenter-smalldisk",
                          "2016-datacenter-smalldisk-g2",
                          "2016-Datacenter-with-Containers",
                          "2016-datacenter-with-containers-g2",
                          "2016-Datacenter-with-RDSH",
                          "2016-Datacenter-zhcn",
                          "2016-datacenter-zhcn-g2",
                          "2019-Datacenter",
                          "2019-Datacenter-Core",
                          "2019-datacenter-core-g2",
                          "2019-Datacenter-Core-smalldisk",
                          "2019-datacenter-core-smalldisk-g2",
                          "2019-Datacenter-Core-with-Containers",
                          "2019-datacenter-core-with-containers-g2",
                          "2019-Datacenter-Core-with-Containers-smalldisk",
                          "2019-datacenter-core-with-containers-smalldisk-g2",
                          "2019-datacenter-gensecond",
                          "2019-datacenter-gs",
                          "2019-Datacenter-smalldisk",
                          "2019-datacenter-smalldisk-g2",
                          "2019-Datacenter-with-Containers",
                          "2019-datacenter-with-containers-g2",
                          "2019-Datacenter-with-Containers-smalldisk",
                          "2019-datacenter-with-containers-smalldisk-g2",
                          "2019-Datacenter-zhcn",
                          "2019-datacenter-zhcn-g2",
                          "Datacenter-Core-1803-with-Containers-smalldisk",
                          "datacenter-core-1803-with-containers-smalldisk-g2",
                          "Datacenter-Core-1809-with-Containers-smalldisk",
                          "datacenter-core-1809-with-containers-smalldisk-g2",
                          "Datacenter-Core-1903-with-Containers-smalldisk",
                          "datacenter-core-1903-with-containers-smalldisk-g2",
                          "datacenter-core-1909-with-containers-smalldisk",
                          "datacenter-core-1909-with-containers-smalldisk-g1",
                          "datacenter-core-1909-with-containers-smalldisk-g2"
                        ]
                      }
                    ]
                  },
                  "then": {
                    "details": {
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "parameters": {
                            "domainFQDN": {
                              "value": "[parameters('domainFQDN')]"
                            },
                            "domainOUPath": {
                              "value": "[parameters('domainOUPath')]"
                            },
                            "domainPassword": {
                              "reference": {
                                "keyVault": {
                                  "id": "[parameters('keyVaultResourceId')]"
                                },
                                "secretName": "[parameters('domainPassword')]"
                              }
                            },
                            "domainUsername": {
                              "reference": {
                                "keyVault": {
                                  "id": "[parameters('keyVaultResourceId')]"
                                },
                                "secretName": "[parameters('domainUsername')]"
                              }
                            },
                            "keyVaultResourceId": {
                              "value": "[parameters('keyVaultResourceId')]"
                            },
                            "location": {
                              "value": "[field('location')]"
                            },
                            "vmName": {
                              "value": "[field('name')]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "outputs": {},
                            "parameters": {
                              "domainFQDN": {
                                "type": "string"
                              },
                              "domainOUPath": {
                                "type": "string"
                              },
                              "domainPassword": {
                                "type": "securestring"
                              },
                              "domainUsername": {
                                "type": "string"
                              },
                              "keyVaultResourceId": {
                                "type": "string"
                              },
                              "location": {
                                "type": "string"
                              },
                              "vmName": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2015-06-15",
                                "location": "[resourceGroup().location]",
                                "name": "[concat(variables('vmName'),'/joindomain')]",
                                "properties": {
                                  "autoUpgradeMinorVersion": true,
                                  "protectedSettings": {
                                    "Password": "[parameters('domainPassword')]"
                                  },
                                  "publisher": "Microsoft.Compute",
                                  "settings": {
                                    "Name": "[parameters('domainFQDN')]",
                                    "OUPath": "[parameters('domainOUPath')]",
                                    "Options": "[variables('domainJoinOptions')]",
                                    "Restart": "true",
                                    "User": "[parameters('domainUserName')]"
                                  },
                                  "type": "JsonADDomainExtension",
                                  "typeHandlerVersion": "1.3"
                                },
                                "type": "Microsoft.Compute/virtualMachines/extensions"
                              }
                            ],
                            "variables": {
                              "domainJoinOptions": 3,
                              "vmName": "[parameters('vmName')]"
                            }
                          }
                        }
                      },
                      "existenceCondition": {
                        "allOf": [
                          {
                            "equals": "JsonADDomainExtension",
                            "field": "Microsoft.Compute/virtualMachines/extensions/type"
                          },
                          {
                            "equals": "Microsoft.Compute",
                            "field": "Microsoft.Compute/virtualMachines/extensions/publisher"
                          }
                        ]
                      },
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "type": "Microsoft.Compute/virtualMachines/extensions"
                    },
                    "effect": "deployIfNotExists"
                  }
                }
              }
            }
          ],
          "policySetDefinitions": [
            {
              "Name": "Deny-PublicEndpoints",
              "PolicySetDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deny-PublicEndpoints",
              "Properties": {
                "Description": "null",
                "DisplayName": "Deny-Public-Endpoints-for-PaaS-Services",
                "Parameters": null,
                "PolicyDefinitionGroups": null,
                "PolicyDefinitions": [
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointCosmosDB",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-CosmosDB",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointMariaDB",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-MariaDB",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointMySQL",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-MySQL",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointPostgreSql",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-PostgreSql",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointKeyVault",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-KeyVault",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointSql",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Sql",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointStorage",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Storage",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DenyPublicEndpointAks",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deny-PublicEndpoint-Aks",
                    "parameters": {}
                  }
                ]
              },
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deny-PublicEndpoints",
              "ResourceName": "Deny-PublicEndpoints",
              "ResourceType": "Microsoft.Authorization/policySetDefinitions",
              "SubscriptionId": null
            },
            {
              "Name": "Deploy-Diag-LogAnalytics",
              "PolicySetDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deploy-Diag-LogAnalytics",
              "Properties": {
                "Description": "This initiative configures application Azure resources to forward diagnostic logs and metrics to an Azure Log Analytics workspace.",
                "DisplayName": "Deploy-Diag-LogAnalytics",
                "Parameters": {
                  "logAnalytics": {
                    "metadata": {
                      "description": "Select the Log Analytics workspace from dropdown list",
                      "displayName": "Log Analytics workspace",
                      "strongType": "omsWorkspace"
                    },
                    "type": "String"
                  }
                },
                "PolicyDefinitionGroups": null,
                "PolicyDefinitions": [
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsNIC",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-NIC",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsPublicIP",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PublicIP",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsLoadBalancer",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LoadBalancer",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsNetworkSecurityGroups",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-NetworkSecurityGroups",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsKeyVault",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-KeyVault",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsCognitiveServices",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CognitiveServices",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsDLAnalytics",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DLAnalytics",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsDataLakeStore",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DataLakeStore",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsEventHub",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventHub",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsiotHub",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-iotHub",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsTimeSeriesInsights",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-TimeSeriesInsights",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsLogicAppsWF",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LogicAppsWF",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsRecoveryVault",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-RecoveryVault",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsSearchServices",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SearchServices",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsServiceBus",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ServiceBus",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsSQLDBs",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLDBs",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsSQLElasticPools",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLElasticPools",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsAPIMgmt",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-APIMgmt",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsApplicationGateway",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ApplicationGateway",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsBatch",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Batch",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsMySQL",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-MySQL",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsPostgreSQL",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PostgreSQL",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsAA",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AA",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsCDNEndpoints",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CDNEndpoints",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsCosmosDB",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-CosmosDB",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsDataFactory",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-DataFactory",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsPowerBIEmbedded",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-PowerBIEmbedded",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsStreamAnalytics",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-StreamAnalytics",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsExpressRoute",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ExpressRoute",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsACI",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ACI",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsACR",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ACR",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsVirtualNetwork",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VirtualNetwork",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsVM",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VM",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsVMSS",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VMSS",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsVNetGW",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VNetGW",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsAKS",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AKS",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsLogicAppsISE",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-LogicAppsISE",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsWebsite",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Website",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsEventGridTopic",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventGridTopic",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsEventGridSub",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-EventGridSub",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsHDInsight",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-HDInsight",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsRedisCache",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-RedisCache",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsRelay",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Relay",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsSignalR",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SignalR",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsTrafficManager",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-TrafficManager",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsWebServerFarm",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-WebServerFarm",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsSQLMI",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-SQLMI",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsFirewall",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Firewall",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsAnalysisService",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-AnalysisService",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "DeployDiagnosticsMlWorkspace",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-MlWorkspace",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[parameters('logAnalytics')]"
                      }
                    }
                  }
                ]
              },
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deploy-Diag-LogAnalytics",
              "ResourceName": "Deploy-Diag-LogAnalytics",
              "ResourceType": "Microsoft.Authorization/policySetDefinitions",
              "SubscriptionId": null
            },
            {
              "Name": "Deploy-Sql-Security",
              "PolicySetDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deploy-Sql-Security",
              "Properties": {
                "Description": "Recommended built-in security policies for the North Star architecture",
                "DisplayName": "Deploy-Sql-Security",
                "Parameters": {
                  "vulnerabilityAssessmentsEmail": {
                    "metadata": {
                      "description": "The email address to send alerts",
                      "displayName": "The email address to send alerts"
                    },
                    "type": "String"
                  },
                  "vulnerabilityAssessmentsStorageID": {
                    "metadata": {
                      "description": "The storage account to store assessments",
                      "displayName": "The storage account to store assessments"
                    },
                    "type": "String"
                  }
                },
                "PolicyDefinitionGroups": null,
                "PolicyDefinitions": [
                  {
                    "policyDefinitionReferenceId": "DeploySqlTde",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-Tde",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DeploySqlSecurityAlertPolicies",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-SecurityAlertPolicies",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DeploySqlAuditingSettings",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-AuditingSettings",
                    "parameters": {}
                  },
                  {
                    "policyDefinitionReferenceId": "DeploySqlvulnerabilityAssessments",
                    "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Sql-vulnerabilityAssessments",
                    "parameters": {
                      "vulnerabilityAssessmentsEmail": {
                        "value": "[parameters('vulnerabilityAssessmentsEmail')]"
                      },
                      "vulnerabilityAssessmentsStorageID": {
                        "value": "[parameters('vulnerabilityAssessmentsStorageID')]"
                      }
                    }
                  }
                ]
              },
              "ResourceId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deploy-Sql-Security",
              "ResourceName": "Deploy-Sql-Security",
              "ResourceType": "Microsoft.Authorization/policySetDefinitions",
              "SubscriptionId": null
            }
          ],
          "policyAssignments": [
            {
              "Identity": {
                "principalId": "9e5eb7a6-a3fa-4b2b-a54f-269f99e91cf6",
                "tenantId": "bb4c9e42-b982-4573-8741-cb71d8b92af4",
                "type": "SystemAssigned"
              },
              "Location": "westeurope",
              "Name": "Deploy-Diag-ActivityLog",
              "PolicyAssignmentId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyAssignments/Deploy-Diag-ActivityLog",
              "Properties": {
                "Description": "Ensure subscriptions have activity logs sent to log analytics",
                "DisplayName": "Deploy-Diagnotics-ActivityLog",
                "NotScopes": null,
                "Parameters": {
                  "logAnalytics": {
                    "value": "/subscriptions/be3ae466-f78a-4e60-b972-d9c35a4e7b3b/resourcegroups/es-mgmt/providers/microsoft.operationalinsights/workspaces/es-la-be3ae466-f78a-4e60-b972-d9c35a4e7b3b"
                  }
                },
                "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ActivityLog",
                "Scope": "/providers/Microsoft.Management/managementGroups/ES"
              },
              "ResourceId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyAssignments/Deploy-Diag-ActivityLog",
              "ResourceName": "Deploy-Diag-ActivityLog",
              "ResourceType": "Microsoft.Authorization/policyAssignments",
              "Sku": {
                "name": "A0",
                "tier": "Free"
              }
            },
            {
              "Identity": {
                "principalId": "fad1bc95-9fb8-4751-bf0e-e887ebb971a2",
                "tenantId": "bb4c9e42-b982-4573-8741-cb71d8b92af4",
                "type": "SystemAssigned"
              },
              "Location": "westeurope",
              "Name": "Deploy-Diag-LogAnalytics",
              "PolicyAssignmentId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyAssignments/Deploy-Diag-LogAnalytics",
              "Properties": {
                "Description": "Ensure resources have diagnostic settings configured to forward to Log Analytics",
                "DisplayName": "Deploy-Diag-LogAnalytics",
                "NotScopes": null,
                "Parameters": {
                  "logAnalytics": {
                    "value": "/subscriptions/be3ae466-f78a-4e60-b972-d9c35a4e7b3b/resourcegroups/es-mgmt/providers/microsoft.operationalinsights/workspaces/es-la-be3ae466-f78a-4e60-b972-d9c35a4e7b3b"
                  }
                },
                "PolicyDefinitionId": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/policySetDefinitions/Deploy-Diag-LogAnalytics",
                "Scope": "/providers/Microsoft.Management/managementGroups/ES"
              },
              "ResourceId": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/policyAssignments/Deploy-Diag-LogAnalytics",
              "ResourceName": "Deploy-Diag-LogAnalytics",
              "ResourceType": "Microsoft.Authorization/policyAssignments",
              "Sku": {
                "name": "A0",
                "tier": "Free"
              }
            }
          ],
          "roleDefinitions": [],
          "roleAssignments": [
            {
              "Id": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/roleAssignments/f0011511-cc4f-4cf1-8488-da691ab48c4c",
              "Name": "f0011511-cc4f-4cf1-8488-da691ab48c4c",
              "properties": {
                "DisplayName": "AzOpsTF",
                "ObjectType": "ServicePrincipal",
                "PrincipalId": "4c4b17c2-26c9-49a0-a122-6c51177bede3",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
                "RoleDefinitionName": "Owner"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            },
            {
              "Id": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/roleAssignments/add56670-de5e-8033-dbf6-9159ca183f7a",
              "Name": "add56670-de5e-8033-dbf6-9159ca183f7a",
              "properties": {
                "DisplayName": "Deploy-Diag-ActivityLog",
                "ObjectType": "ServicePrincipal",
                "PrincipalId": "9e5eb7a6-a3fa-4b2b-a54f-269f99e91cf6",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
                "RoleDefinitionName": "Owner"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            },
            {
              "Id": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/roleAssignments/98f95462-5891-430c-b6be-43f6542f9aae",
              "Name": "98f95462-5891-430c-b6be-43f6542f9aae",
              "properties": {
                "DisplayName": null,
                "ObjectType": "Unknown",
                "PrincipalId": "1f7a25e6-d860-4ad4-9c00-bc24d122db91",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
                "RoleDefinitionName": "Contributor"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            },
            {
              "Id": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/roleAssignments/363a06fc-6bed-4695-b1ad-e7b4144cc89d",
              "Name": "363a06fc-6bed-4695-b1ad-e7b4144cc89d",
              "properties": {
                "DisplayName": null,
                "ObjectType": "Unknown",
                "PrincipalId": "44116afc-69a4-4ed5-9d40-9da86712b044",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
                "RoleDefinitionName": "Contributor"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            },
            {
              "Id": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/roleAssignments/ed88e321-b99e-45ed-a65d-6b2e07174b53",
              "Name": "ed88e321-b99e-45ed-a65d-6b2e07174b53",
              "properties": {
                "DisplayName": null,
                "ObjectType": "Unknown",
                "PrincipalId": "a0bbb44c-5f14-4db9-adcc-4445816012df",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
                "RoleDefinitionName": "Contributor"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            },
            {
              "Id": "/providers/Microsoft.Management/managementgroups/ES/providers/Microsoft.Authorization/roleAssignments/98f95462-5891-430c-b6be-43f6542f9aa2",
              "Name": "98f95462-5891-430c-b6be-43f6542f9aa2",
              "properties": {
                "DisplayName": null,
                "ObjectType": "Unknown",
                "PrincipalId": "b925d4d9-30a8-4655-a5ee-46395f359a1e",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
                "RoleDefinitionName": "Contributor"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            },
            {
              "Id": "/providers/Microsoft.Management/managementGroups/ES/providers/Microsoft.Authorization/roleAssignments/bc8c5fbb-2a72-2096-f452-6aa887a9445f",
              "Name": "bc8c5fbb-2a72-2096-f452-6aa887a9445f",
              "properties": {
                "DisplayName": "Deploy-Diag-LogAnalytics",
                "ObjectType": "ServicePrincipal",
                "PrincipalId": "fad1bc95-9fb8-4751-bf0e-e887ebb971a2",
                "RoleDefinitionId": "/providers/Microsoft.Authorization/RoleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
                "RoleDefinitionName": "Contributor"
              },
              "ResourceType": "Microsoft.Authorization/roleAssignments"
            }
          ]
        }
      }
    }
  }
}
